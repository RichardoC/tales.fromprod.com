<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav ul li a { background-image: none; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Finding secrets on GitLab | Tales from Prod</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Finding secrets on GitLab" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Finding secrets on GitLab" /> <meta property="og:description" content="Finding secrets on GitLab" /> <link rel="canonical" href="https://tales.fromprod.com/2024/056/gitlab-secrets.html" /> <meta property="og:url" content="https://tales.fromprod.com/2024/056/gitlab-secrets.html" /> <meta property="og:site_name" content="Tales from Prod" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-02-25T11:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Finding secrets on GitLab" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-02-25T11:00:00+00:00","datePublished":"2024-02-25T11:00:00+00:00","description":"Finding secrets on GitLab","headline":"Finding secrets on GitLab","mainEntityOfPage":{"@type":"WebPage","@id":"https://tales.fromprod.com/2024/056/gitlab-secrets.html"},"url":"https://tales.fromprod.com/2024/056/gitlab-secrets.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> Tales from Prod </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="/" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/categories/" class="nav-list-link">Categories</a></li><li class="nav-list-item"><a href="/useful-resources.html" class="nav-list-link">Useful resources</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Tales from Prod" aria-label="Search Tales from Prod" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="finding-secrets-on-gitlab"> <a href="#finding-secrets-on-gitlab" class="anchor-heading" aria-labelledby="finding-secrets-on-gitlab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Finding secrets on GitLab </h1> <p>Everyone’s been there before, you included something you shouldn’t have in a commit so you undo the commit and force push.</p> <p>This data’s gone, right?(!)</p> <p>This blog post is about finding those mistakenly published commits, and to serve as a reminder that you should always rotate potentially exposed credentials even if you think you’ve deleted them.</p> <h2 id="how-can-these-missing-commits-still-exist"> <a href="#how-can-these-missing-commits-still-exist" class="anchor-heading" aria-labelledby="how-can-these-missing-commits-still-exist"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How can these “missing commits” still exist? </h2> <p>When you force pushed your branch you rewrote the branch history to no longer reference those commits. This doesn’t remove those commits though, it just detached them from the chain of commits that represents the branch. commits still exist on the GitLab server despite being inaccessible via the branches.</p> <p>Here’s a writeup of how this works <a href="https://git-scm.com/book/en/v2/Git-Internals-Maintenance-and-Data-Recovery">locally</a></p> <h2 id="how-do-we-find-these-missing-commits"> <a href="#how-do-we-find-these-missing-commits" class="anchor-heading" aria-labelledby="how-do-we-find-these-missing-commits"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How do we find these missing commits </h2> <p>In theory GitLab have an API for getting commits from a repository, and there’s a parameter for getting <code class="language-plaintext highlighter-rouge">all</code> commits.</p> <p>As of the time of writing, this API fails to return these dangling commits <a href="https://gitlab.com/gitlab-org/gitlab/-/issues/443263">https://gitlab.com/gitlab-org/gitlab/-/issues/443263</a> which I consider a bug.</p> <p>However, every time a commit is pushed a <code class="language-plaintext highlighter-rouge">pushed to</code> <a href="https://docs.gitlab.com/ee/api/events.html">event</a> is generated by GitLab. An example of this is below.</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3182909502</span><span class="p">,</span><span class="w">
    </span><span class="nl">"project_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">55263882</span><span class="p">,</span><span class="w">
    </span><span class="nl">"action_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pushed to"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"target_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"target_iid"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"target_type"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"author_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">20255114</span><span class="p">,</span><span class="w">
    </span><span class="nl">"target_title"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
    </span><span class="nl">"created_at"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-02-24T21:29:08.711Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">20255114</span><span class="p">,</span><span class="w">
      </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RichardoC"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Richard Tweed"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"locked"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"avatar_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://secure.gravatar.com/avatar/3af3c4bc67b146186dbd2ef852f8faa16c91d9268e81b7b292168e7dc1fdc7b6?s=80&amp;d=identicon"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"web_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://gitlab.com/RichardoC"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"push_data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"commit_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pushed"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ref_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"branch"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"commit_from"</span><span class="p">:</span><span class="w"> </span><span class="s2">"31ed8bb6dd627bd38fba1aa350a15136c636c932"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"commit_to"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7faedfa06dd7dda69ca94169c9ec01aa605da08b"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"main"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"commit_title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tidy readme"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ref_count"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"author_username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RichardoC"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>These events reference the <code class="language-plaintext highlighter-rouge">commit_from</code> and <code class="language-plaintext highlighter-rouge">commit_to</code> commits. These can be used to generate a set of all commits that actually happened over the last 3 years (they’re only retained for 3 years)</p> <p>By comparing that set with the official history (the all commits API above) we can find dangling commits, and generate the URL where they can be seen.</p> <h2 id="very-cool-wheres-the-code"> <a href="#very-cool-wheres-the-code" class="anchor-heading" aria-labelledby="very-cool-wheres-the-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Very cool, where’s the code? </h2> <p><a href="https://github.com/RichardoC/gitlab-secrets">https://github.com/RichardoC/gitlab-secrets</a></p> <p>An example Gitlab repo with dangling commits can be found at <a href="https://gitlab.com/gitlab-secrets/gitlab-secrets">https://gitlab.com/gitlab-secrets/gitlab-secrets</a> for you to test this out with</p> <h2 id="original-idea"> <a href="#original-idea" class="anchor-heading" aria-labelledby="original-idea"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Original idea </h2> <p>This was based on the work by Neodyme where they used this technique to find secrets on <a href="https://neodyme.io/en/blog/github_secrets/">GitHub</a></p> </main> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2025 Richard Finlay Tweed. All rights reserved. All views expressed are my own</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
