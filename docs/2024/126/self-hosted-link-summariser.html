<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav ul li a { background-image: none; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Making a self hosted link summariser | Tales from Prod</title> <meta name="generator" content="Jekyll v3.9.5" /> <meta property="og:title" content="Making a self hosted link summariser" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Making a self hosted link summariser using LLMs" /> <meta property="og:description" content="Making a self hosted link summariser using LLMs" /> <link rel="canonical" href="https://tales.fromprod.com/2024/126/self-hosted-link-summariser.html" /> <meta property="og:url" content="https://tales.fromprod.com/2024/126/self-hosted-link-summariser.html" /> <meta property="og:site_name" content="Tales from Prod" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-05-05T19:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Making a self hosted link summariser" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-05T19:00:00+00:00","datePublished":"2024-05-05T19:00:00+00:00","description":"Making a self hosted link summariser using LLMs","headline":"Making a self hosted link summariser","mainEntityOfPage":{"@type":"WebPage","@id":"https://tales.fromprod.com/2024/126/self-hosted-link-summariser.html"},"url":"https://tales.fromprod.com/2024/126/self-hosted-link-summariser.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> Tales from Prod </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="/" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/categories/" class="nav-list-link">Categories</a></li><li class="nav-list-item"><a href="/useful-resources.html" class="nav-list-link">Useful resources</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Tales from Prod" aria-label="Search Tales from Prod" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="making-a-self-hosted-link-summariser-using-llms"> <a href="#making-a-self-hosted-link-summariser-using-llms" class="anchor-heading" aria-labelledby="making-a-self-hosted-link-summariser-using-llms"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Making a self hosted link summariser using LLMs </h1> <p>If you use Reddit or Lemmy you are likely to be familiar with those bots which summarise news links and comment the result. I decided to make one of these which uses an LLM to do the summarisation</p> <h2 id="step-1-get-the-websites-text"> <a href="#step-1-get-the-websites-text" class="anchor-heading" aria-labelledby="step-1-get-the-websites-text"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Get the website’s text </h2> <p>For this you want to get the page’s HTML, and remove anything that won’t help the bot such as javascript, CSS, images or videos. You’ll also want to get rid of excessive spaces or newlines as they’ll take up tokens that could be used for more words</p> <div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">func</span> <span class="n">standardizeSpaces</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">strings</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">Fields</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s">" "</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">scrapeSite</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">slog</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"Failed to get site"</span><span class="p">,</span> <span class="s">"site"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s">"error"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

	<span class="n">doc</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">goquery</span><span class="o">.</span><span class="n">NewDocumentFromReader</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">slog</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"Failed to get site body"</span><span class="p">,</span> <span class="s">"site"</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s">"error"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">"img"</span><span class="p">)</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">,</span> <span class="n">el</span> <span class="o">*</span><span class="n">goquery</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">el</span><span class="o">.</span><span class="n">Remove</span><span class="p">()</span>
	<span class="p">})</span>
	<span class="c">// We don't care about images, we only want the text on the site</span>
	<span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">"picture"</span><span class="p">)</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">,</span> <span class="n">el</span> <span class="o">*</span><span class="n">goquery</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">el</span><span class="o">.</span><span class="n">Remove</span><span class="p">()</span>
	<span class="p">})</span>
	<span class="c">// We don't care about scripts, we only want the text on the site</span>
	<span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">"script"</span><span class="p">)</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">,</span> <span class="n">el</span> <span class="o">*</span><span class="n">goquery</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">el</span><span class="o">.</span><span class="n">Remove</span><span class="p">()</span>
	<span class="p">})</span>
	<span class="c">// We don't care about css, we only want the text on the site</span>
	<span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">"style"</span><span class="p">)</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">,</span> <span class="n">el</span> <span class="o">*</span><span class="n">goquery</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">el</span><span class="o">.</span><span class="n">Remove</span><span class="p">()</span>
	<span class="p">})</span>
	<span class="c">// We don't care about videos, we only want the text on the site</span>
	<span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">"video"</span><span class="p">)</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">,</span> <span class="n">el</span> <span class="o">*</span><span class="n">goquery</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">el</span><span class="o">.</span><span class="n">Remove</span><span class="p">()</span>
	<span class="p">})</span>

	<span class="c">// There's unlikely to be anything we want in these</span>
	<span class="n">doc</span><span class="o">.</span><span class="n">Find</span><span class="p">(</span><span class="s">"noscript"</span><span class="p">)</span><span class="o">.</span><span class="n">Each</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">i</span> <span class="kt">int</span><span class="p">,</span> <span class="n">el</span> <span class="o">*</span><span class="n">goquery</span><span class="o">.</span><span class="n">Selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">el</span><span class="o">.</span><span class="n">Remove</span><span class="p">()</span>
	<span class="p">})</span>

	<span class="c">// remove excess newlines etc</span>
	<span class="n">bdyText</span> <span class="o">:=</span> <span class="n">standardizeSpaces</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">Text</span><span class="p">())</span>
	<span class="n">slog</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">bdyText</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">bdyText</span><span class="p">,</span> <span class="n">err</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="step-2-use-the-llm-to-summarise-the-text"> <a href="#step-2-use-the-llm-to-summarise-the-text" class="anchor-heading" aria-labelledby="step-2-use-the-llm-to-summarise-the-text"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Use the LLM to summarise the text </h2> <p>For this you’ll need to truncate the content from the site if it’s too long, and send it over to the LLM, with a prompt and “thought” that it should do this.</p> <div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">func</span> <span class="n">doSummarisation</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">,</span> <span class="n">maxTokens</span> <span class="kt">int</span><span class="p">,</span> <span class="n">server</span> <span class="kt">string</span><span class="p">,</span> <span class="n">model</span> <span class="kt">string</span><span class="p">,</span> <span class="n">siteText</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">summary</span> <span class="kt">string</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">lengthOfDataToSend</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">siteText</span><span class="p">)</span>

	<span class="c">// Just a rule of thumb</span>
	<span class="n">likelyMaximumLengthAccepted</span> <span class="o">:=</span> <span class="m">2</span> <span class="o">*</span> <span class="n">maxTokens</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">siteText</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">2</span><span class="o">*</span><span class="n">likelyMaximumLengthAccepted</span> <span class="p">{</span>
		<span class="n">lengthOfDataToSend</span> <span class="o">=</span> <span class="m">2</span> <span class="o">*</span> <span class="n">likelyMaximumLengthAccepted</span>
	<span class="p">}</span>

	<span class="n">aiClient</span> <span class="o">:=</span> <span class="n">openai</span><span class="o">.</span><span class="n">DefaultConfig</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
	<span class="n">aiClient</span><span class="o">.</span><span class="n">BaseURL</span> <span class="o">=</span> <span class="n">server</span>
	<span class="n">client</span> <span class="o">:=</span> <span class="n">openai</span><span class="o">.</span><span class="n">NewClientWithConfig</span><span class="p">(</span><span class="n">aiClient</span><span class="p">)</span>

	<span class="n">stream</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">CreateChatCompletionStream</span><span class="p">(</span>
		<span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span>
		<span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletionRequest</span><span class="p">{</span>
			<span class="n">Model</span><span class="o">:</span> <span class="n">model</span><span class="p">,</span>
			<span class="n">Messages</span><span class="o">:</span> <span class="p">[]</span><span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletionMessage</span><span class="p">{</span>
				<span class="p">{</span><span class="n">Role</span><span class="o">:</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatMessageRoleSystem</span><span class="p">,</span>
					<span class="n">Content</span><span class="o">:</span> <span class="s">"You are an expert at summarising text in a concise manner for intelligent social media users."</span><span class="p">,</span>
				<span class="p">},</span>
				<span class="p">{</span>
					<span class="n">Role</span><span class="o">:</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatMessageRoleUser</span><span class="p">,</span>
					<span class="n">Content</span><span class="o">:</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"Summarise the following text using the fewest possible words</span><span class="se">\n</span><span class="s">, %s"</span><span class="p">,</span>
						<span class="n">siteText</span><span class="p">[</span><span class="o">:</span><span class="n">lengthOfDataToSend</span><span class="o">-</span><span class="m">1</span><span class="p">]),</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">Stream</span><span class="o">:</span>           <span class="no">true</span><span class="p">,</span>
			<span class="n">Stop</span><span class="o">:</span>             <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"&lt;|end_of_text|&gt;"</span><span class="p">,</span> <span class="s">"&lt;|eot_id|&gt;"</span><span class="p">},</span>
			<span class="n">Temperature</span><span class="o">:</span>      <span class="m">0.7</span><span class="p">,</span>
			<span class="n">TopP</span><span class="o">:</span>             <span class="m">0.95</span><span class="p">,</span>
			<span class="n">MaxTokens</span><span class="o">:</span>        <span class="n">maxTokens</span><span class="p">,</span>
			<span class="n">FrequencyPenalty</span><span class="o">:</span> <span class="m">0.0</span><span class="p">,</span>
			<span class="n">PresencePenalty</span><span class="o">:</span>  <span class="m">0.0</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">slog</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"Error with ChatCompletionStream for summariser"</span><span class="p">,</span> <span class="s">"error"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">stream</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

	<span class="k">var</span> <span class="n">summaryBuilder</span> <span class="n">strings</span><span class="o">.</span><span class="n">Builder</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">var</span> <span class="n">response</span> <span class="n">openai</span><span class="o">.</span><span class="n">ChatCompletionStreamResponse</span>
		<span class="n">response</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Recv</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">Is</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slog</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"Finished receiving response from LLM"</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">summaryBuilder</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="no">nil</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">slog</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"Error with ChatCompletionStream for summariser"</span><span class="p">,</span> <span class="s">"error"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">summaryBuilder</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">err</span>
		<span class="p">}</span>
		<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">summaryBuilder</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">Choices</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="n">Delta</span><span class="o">.</span><span class="n">Content</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">slog</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"Error with writing stream to summary"</span><span class="p">,</span> <span class="s">"error"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">summaryBuilder</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">err</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="c">// Never get here</span>

<span class="p">}</span>

</code></pre></div></div> <h2 id="the-code"> <a href="#the-code" class="anchor-heading" aria-labelledby="the-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The code </h2> <p>Full version of this code available at <a href="https://github.com/RichardoC/personal-webpage-summariser">https://github.com/RichardoC/personal-webpage-summariser</a></p> <p>Better versions exist such as <a href="https://github.com/RikudouSage/LemmyAutoTldrBot">https://github.com/RikudouSage/LemmyAutoTldrBot</a></p> </main> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2024 Richard Finlay Tweed. All rights reserved. All views expressed are my own</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
