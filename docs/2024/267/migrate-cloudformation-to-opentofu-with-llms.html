<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav ul li a { background-image: none; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Migrate cloudformation to opentofu with LLMs | Tales from Prod</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="Migrate cloudformation to opentofu with LLMs" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Migrate cloudformation to opentofu with LLMs" /> <meta property="og:description" content="Migrate cloudformation to opentofu with LLMs" /> <link rel="canonical" href="https://tales.fromprod.com/2024/267/migrate-cloudformation-to-opentofu-with-llms.html" /> <meta property="og:url" content="https://tales.fromprod.com/2024/267/migrate-cloudformation-to-opentofu-with-llms.html" /> <meta property="og:site_name" content="Tales from Prod" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-09-23T15:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Migrate cloudformation to opentofu with LLMs" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-09-23T15:00:00+00:00","datePublished":"2024-09-23T15:00:00+00:00","description":"Migrate cloudformation to opentofu with LLMs","headline":"Migrate cloudformation to opentofu with LLMs","mainEntityOfPage":{"@type":"WebPage","@id":"https://tales.fromprod.com/2024/267/migrate-cloudformation-to-opentofu-with-llms.html"},"url":"https://tales.fromprod.com/2024/267/migrate-cloudformation-to-opentofu-with-llms.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> Tales from Prod </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="/" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/categories/" class="nav-list-link">Categories</a></li><li class="nav-list-item"><a href="/useful-resources.html" class="nav-list-link">Useful resources</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Tales from Prod" aria-label="Search Tales from Prod" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="migrate-cloudformation-to-opentofu-with-llms"> <a href="#migrate-cloudformation-to-opentofu-with-llms" class="anchor-heading" aria-labelledby="migrate-cloudformation-to-opentofu-with-llms"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Migrate cloudformation to opentofu with LLMs </h1> <p>I discovered that Cloudformation won’t override manual changes so decided to migrate a typescript CDK stack over to openTofu. This means I now get to the delta between reality and what I requested.</p> <p>However, migrating between these technologies can be fiddly so figured I should get some help generating the bulk of the required changes and I can then manually tweak as required.</p> <h2 id="first-attempt---cf2tf"> <a href="#first-attempt---cf2tf" class="anchor-heading" aria-labelledby="first-attempt---cf2tf"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> First attempt - cf2tf </h2> <p><a href="https://github.com/DontShaveTheYak/cf2tf">https://github.com/DontShaveTheYak/cf2tf</a> - A nice tool, but requires quite a lot of manual changes to the resulting Terraform in my experience.</p> <h3 id="steps"> <a href="#steps" class="anchor-heading" aria-labelledby="steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Steps </h3> <ul> <li>npx cdk synth MyStack</li> <li>cf2tf MyStack.template.json</li> <li>manually fix the openTofu to cover all resources</li> <li>run <code class="language-plaintext highlighter-rouge">tofu init</code></li> <li>manually write all the required <code class="language-plaintext highlighter-rouge">tofu import</code> statements to ensure all resources governed by openTofu</li> <li>Check in AWS Cloudformation Console that every <code class="language-plaintext highlighter-rouge">resource</code> has an openTofu entry</li> <li>In the AWS Cloudformation Console manually update the cloudformation template in Application Composer to ensure all resources have a DeletionPolicy: Retain</li> <li>Delete the Cloudformation Stack via the console</li> <li>Delete the stack from the local repo</li> </ul> <h2 id="second-attempt---openais-o1-preview-llm"> <a href="#second-attempt---openais-o1-preview-llm" class="anchor-heading" aria-labelledby="second-attempt---openais-o1-preview-llm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Second attempt - OpenAI’s o1-preview LLM </h2> <p>The steps listed are similar to the first attempt, but far fewer manual changes were required and typically the import commands were writen correctly. This worked well for stacks with small numbers of resources (~10) and less well on large stacks (~80 resources)</p> <p>Just change any terraform commands to <code class="language-plaintext highlighter-rouge">tofu</code></p> <h3 id="steps-1"> <a href="#steps-1" class="anchor-heading" aria-labelledby="steps-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Steps </h3> <ul> <li>npx cdk synth MyStack</li> <li>Add files to the template prompt</li> <li>run prompt via chatgpt or API</li> <li>run <code class="language-plaintext highlighter-rouge">tofu init</code></li> <li>Check the required <code class="language-plaintext highlighter-rouge">tofu import</code> statements provided, and run them to ensure all resources governed by openTofu</li> <li>Check in AWS Cloudformation Console that every <code class="language-plaintext highlighter-rouge">resource</code> has an openTofu entry</li> <li>In the AWS Cloudformation Console manually update the cloudformation template in Application Composer to ensure all resources have a DeletionPolicy: Retain</li> <li>Delete the Cloudformation Stack via the console</li> <li>Delete the stack from the local repo</li> </ul> <h4 id="prompt"> <a href="#prompt" class="anchor-heading" aria-labelledby="prompt"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prompt </h4> <p>Add the relevant files between the [START FILE: XXX] and [END FILE] tags, then send this over via the openAI API, or via ChatGPT.</p> <p>Do <strong>NOT</strong> use the file upload function of chatgpt, it performs much worse on the details which mean the imports don’t work. I suspect this is because it’s using RAG on the files, rather than including them in their entirety in the context.</p> <p>I tested this with <code class="language-plaintext highlighter-rouge">o1-preview-2024-09-12</code></p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Convert this cloudformation cdk in typescript to terraform. It's infrastructure as code for an AWS environment. It already exists so I'll have to do terraform imports of the existing resources. Include the import statements.

Here is the cloudformation template

[START FILE: MyStack.assets.json]

[END FILE]

[START FILE: MyStack.template.json]

[END FILE]

[START FILE: library.ts]
// some actual cloudformation stacks

[END FILE]

[START FILE: manifest.json]

[END FILE]

</code></pre></div></div> </main> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2024 Richard Finlay Tweed. All rights reserved. All views expressed are my own</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
