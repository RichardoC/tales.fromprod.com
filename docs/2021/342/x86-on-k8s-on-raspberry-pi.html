<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn't! - Tales from Prod</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t! | Tales from Prod</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!" /> <meta property="og:description" content="Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!" /> <link rel="canonical" href="https://tales.fromprod.com/2021/342/x86-on-k8s-on-raspberry-pi.html" /> <meta property="og:url" content="https://tales.fromprod.com/2021/342/x86-on-k8s-on-raspberry-pi.html" /> <meta property="og:site_name" content="Tales from Prod" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-12-08T19:00:00+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!" /> <script type="application/ld+json"> {"description":"Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!","@type":"BlogPosting","headline":"Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!","dateModified":"2021-12-08T19:00:00+00:00","datePublished":"2021-12-08T19:00:00+00:00","url":"https://tales.fromprod.com/2021/342/x86-on-k8s-on-raspberry-pi.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://tales.fromprod.com/2021/342/x86-on-k8s-on-raspberry-pi.html"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="https://tales.fromprod.com/" class="site-title lh-tight"> Tales from Prod </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="https://tales.fromprod.com/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://tales.fromprod.com/" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="https://tales.fromprod.com/categories/" class="nav-list-link">Categories</a></li><li class="nav-list-item"><a href="https://tales.fromprod.com/useful-resources.html" class="nav-list-link">Useful resources</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Tales from Prod" aria-label="Search Tales from Prod" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="running-a-kubernetes-native-x86_64-application-on-raspberry-pis-and-why-you-shouldnt"> <a href="#running-a-kubernetes-native-x86_64-application-on-raspberry-pis-and-why-you-shouldnt" class="anchor-heading" aria-labelledby="running-a-kubernetes-native-x86_64-application-on-raspberry-pis-and-why-you-shouldnt"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t! </h1> <p>While this guide does work, don’t do this. Emulation is <em>slow</em> and Raspberry Pi CPUs (even overclocked to 2GHz) are slower!</p> <p>Also, you have to use x86_64 emulation (rather than KVM) because Pis use an ARM instruction set rather than x86.</p> <h2 id="cpu-benchmark-for-slowness"> <a href="#cpu-benchmark-for-slowness" class="anchor-heading" aria-labelledby="cpu-benchmark-for-slowness"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CPU benchmark for slowness </h2> <p>This benchmark is terrible, but gives an indication of single threaded performance</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#On my work machine</span>
<span class="nb">time dd </span><span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/dev/null <span class="nv">bs</span><span class="o">=</span>2000000 <span class="nv">count</span><span class="o">=</span>100

real	0m4.264s
user	0m0.000s
sys	0m4.264s

<span class="c"># On a VM on k3s-005</span>
<span class="nv">$ </span><span class="nb">time dd </span><span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/dev/null <span class="nv">bs</span><span class="o">=</span>2000000 <span class="nv">count</span><span class="o">=</span>100

real 0m 19.08s
user 0m 0.03s
sys 0m 18.94s

<span class="c"># Natively on that Pi</span>
pi@node-005:~ <span class="nv">$ </span><span class="nb">time dd </span><span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/dev/null <span class="nv">bs</span><span class="o">=</span>2000000 <span class="nv">count</span><span class="o">=</span>100

real	0m2.784s
user	0m0.004s
sys	0m2.769s
</code></pre></div></div> <h2 id="architecture"> <a href="#architecture" class="anchor-heading" aria-labelledby="architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Architecture </h2> <div align="center">x86_64 Application</div> <div align="center">Kubernetes (k3s)</div> <div align="center">QEMU x86_64 emulation</div> <div align="center">Raspberry Pis</div> <h2 id="equipment-in-use"> <a href="#equipment-in-use" class="anchor-heading" aria-labelledby="equipment-in-use"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Equipment in use </h2> <ul> <li>4 * Pi 4 8GB</li> <li>SSD enclosure per Pi supporting UASP</li> <li>SSD per Pi</li> <li>Ethernet switch</li> <li>A router</li> <li>Power</li> <li>misc cables</li> </ul> <h2 id="oss-in-use"> <a href="#oss-in-use" class="anchor-heading" aria-labelledby="oss-in-use"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OSs in use </h2> <ul> <li>Raspbian 64 bit on the Pis</li> <li>Alpine in the x86_64 VMs</li> </ul> <h2 id="setting-up-the-pis"> <a href="#setting-up-the-pis" class="anchor-heading" aria-labelledby="setting-up-the-pis"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up the Pis </h2> <p>We installed 64 bit Raspbian on the SSDs and booted from them.</p> <h3 id="installing-the-dependencies"> <a href="#installing-the-dependencies" class="anchor-heading" aria-labelledby="installing-the-dependencies"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installing the dependencies </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt upgrade <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> qemu nmon virtinst qemu-utils qemu-system-x86 tmux vim dnsmasq-utils dnsmasq-base iptables libvirt-daemon-system
</code></pre></div></div> <h3 id="overclocking-the-pis"> <a href="#overclocking-the-pis" class="anchor-heading" aria-labelledby="overclocking-the-pis"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overclocking the Pis </h3> <p>The Raspberry Pi doesn’t have the fastest CPU, so we overclocked it to 2GHz and over_voltage 6 to keep the warranty. Full guide <a href="https://www.seeedstudio.com/blog/2020/02/12/how-to-safely-overclock-your-raspberry-pi-4-to-2-147ghz/">https://www.seeedstudio.com/blog/2020/02/12/how-to-safely-overclock-your-raspberry-pi-4-to-2-147ghz/</a></p> <h3 id="setting-up-the-qemu-groups"> <a href="#setting-up-the-qemu-groups" class="anchor-heading" aria-labelledby="setting-up-the-qemu-groups"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up the QEMU groups </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>groupadd libvirt-qemu
groupadd libvirt
groupadd libvirtd
useradd <span class="nt">-g</span> libvirt-qemu libvirt-qemu
</code></pre></div></div> <h3 id="setting-up-swap-in-case-its-need-since-8gb-ram-isnt-much"> <a href="#setting-up-swap-in-case-its-need-since-8gb-ram-isnt-much" class="anchor-heading" aria-labelledby="setting-up-swap-in-case-its-need-since-8gb-ram-isnt-much"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up swap (in case it’s need since 8GB RAM isn’t much) </h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create and mount swap</span>
<span class="nb">sudo </span>fallocate <span class="nt">-l</span> 64G /swapfile <span class="o">&amp;&amp;</span> <span class="nb">sudo chmod </span>600 /swapfile <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>mkswap /swapfile <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>swapon /swapfile
</code></pre></div></div> <p>Next add an entry to fstab so that the swap is mounted on boot.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su <span class="nt">-c</span> <span class="s2">"echo '/swapfile swap swap defaults 0 0' &gt;&gt; /etc/fstab"</span>
</code></pre></div></div> <p>Next check that trim works on the PI, if it’s working you should get something similar to the following</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>fstrim <span class="nt">-av</span>
/boot: 0 B <span class="o">(</span>0 bytes<span class="o">)</span> trimmed
/: 19.9 GiB <span class="o">(</span>21294051328 bytes<span class="o">)</span> trimmed
</code></pre></div></div> <p>If this fails, you’ll need to follow <a href="https://www.jeffgeerling.com/blog/2020/enabling-trim-on-external-ssd-on-raspberry-pi">https://www.jeffgeerling.com/blog/2020/enabling-trim-on-external-ssd-on-raspberry-pi</a></p> <p>Due to the high volume of writes expected since the SSD will be used as RAM, configure TRIM to run frequently to prevent rapid deterioration of the SSD.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># trimming every 2 min:</span>
<span class="nb">sudo </span>vi /lib/systemd/system/fstrim.timer
<span class="c"># change:</span>
<span class="o">[</span>Timer]
<span class="nv">OnCalender</span><span class="o">=</span><span class="k">*</span>:0/2
<span class="nv">AccuracySec</span><span class="o">=</span>0

<span class="nb">sudo </span>systemctl daemon-reload
</code></pre></div></div> <h3 id="setting-up-the-bridge-networking-so-the-vms-can-connect-directly-helpful-for-k8s"> <a href="#setting-up-the-bridge-networking-so-the-vms-can-connect-directly-helpful-for-k8s" class="anchor-heading" aria-labelledby="setting-up-the-bridge-networking-so-the-vms-can-connect-directly-helpful-for-k8s"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up the Bridge networking so the VMs can connect directly (helpful for k8s) </h3> <p>Largely following <a href="https://www.raspberrypi.com/documentation/computers/configuration.html#bridging">https://www.raspberrypi.com/documentation/computers/configuration.html#bridging</a></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su <span class="nt">-c</span> <span class="s2">"echo '[NetDev]
Name=br0
Kind=bridge
' &gt;&gt; /etc/systemd/network/bridge-br0.netdev"</span>

<span class="nb">sudo </span>su <span class="nt">-c</span> <span class="s2">"echo '[Match]
Name=eth0

[Network]
Bridge=br0
' &gt;&gt; /etc/systemd/network/bridge-br0.netdev"</span>
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>systemd-networkd

</code></pre></div></div> <p>Next ensure that eth0 is on the bridge network, and it’s the bridge that does dhcp rather than other interfaces</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/dhcpcd.conf
<span class="c"># At top add the following, without the #</span>
<span class="c"># denyinterfaces wlan0 eth0</span>

<span class="c"># at the very bottom add, without the #</span>
<span class="c"># interface br0</span>

</code></pre></div></div> <p>Next is to let QEMU use this bridge, largely following <a href="https://wiki.archlinux.org/title/QEMU#Bridged_networking_using_qemu-bridge-helper">https://wiki.archlinux.org/title/QEMU#Bridged_networking_using_qemu-bridge-helper</a></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /etc/qemu

<span class="c"># Add all that into a script (run as root):</span>
<span class="c">#!bin/bash</span>

<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; /etc/systemd/network/bridge-br0.netdev
[NetDev]
Name=br0
Kind=bridge
</span><span class="no">EOT

</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh"> &gt; /etc/systemd/network/br0-member-eth0.network
[Match]
Name=eth0

[Network]
Bridge=br0
</span><span class="no">EOT

</span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'1s/^/denyinterfaces wlan0 eth0 \n/'</span> /etc/dhcpcd.conf
<span class="nb">echo</span> <span class="s2">"interface br0"</span> <span class="o">&gt;&gt;</span> /etc/dhcpcd.conf

<span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/etc/qemu"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">mkdir</span> /etc/qemu
<span class="k">fi
</span><span class="nb">echo</span> <span class="s2">"allow br0"</span> <span class="o">&gt;</span> /etc/qemu/bridge.conf


<span class="c">#then need to execute later</span>
systemctl <span class="nb">enable </span>system-networkd

</code></pre></div></div> <h3 id="running-the-x86-vm"> <a href="#running-the-x86-vm" class="anchor-heading" aria-labelledby="running-the-x86-vm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running the x86 VM </h3> <p>For the VM we used Alpine as it’s a light OS and compatible with k3s. You can choose your download from <a href="https://alpinelinux.org/downloads/">https://alpinelinux.org/downloads/</a></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://dl-cdn.alpinelinux.org/alpine/v3.15/releases/x86_64/alpine-virt-3.15.0-x86_64.iso
</code></pre></div></div> <p>Next you’ll have to create a disk image for the Alpine VM, we created a 128GB sparse image given the size of the SSDs we used.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-img create <span class="nt">-f</span> qcow2 alpine.qcow2 128G

</code></pre></div></div> <p>Now to run the VM, this command must be run from a display because it attempts to open a window. It is possible to do this in a headless fashion, but we couldn’t get that working. Each VM needs a unique mac address for the networking to work correctly</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>qemu-system-x86_64 <span class="nt">--name</span> alpine-node <span class="nt">-drive</span> <span class="nv">file</span><span class="o">=</span>/home/pi/alpine.qcow2 <span class="nt">-smp</span> <span class="nv">cpus</span><span class="o">=</span>4 <span class="nt">-m</span> 60G,slots<span class="o">=</span>4,maxmem<span class="o">=</span>61G <span class="nt">-accel</span> tcg,thread<span class="o">=</span>multi <span class="nt">-nic</span> bridge,br<span class="o">=</span>br0,model<span class="o">=</span>virtio-net-pci,mac<span class="o">=</span>52:54:00:12:34:50
</code></pre></div></div> <p>Exciting options, <code class="language-plaintext highlighter-rouge">-accel tcg,thread=multi</code> enables the VM to use multiple host cores <code class="language-plaintext highlighter-rouge">virtio-net-pci</code> allows a virtual nic that works with the bridge configured.</p> <p>You should ensure each of these VMs have a unique hostname, and a static IP in your router. This will make k3s configuration much easier</p> <h2 id="configuring-k3s"> <a href="#configuring-k3s" class="anchor-heading" aria-labelledby="configuring-k3s"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring k3s </h2> <p>For our setup, one Pi ran the k3s control plane natively (and didn’t have a VM running) and the other Pis each had a VM running. Those VMs were joined to the k3s cluster as worker nodes.</p> <p>Before installing on the control node, follow <a href="https://rancher.com/docs/k3s/latest/en/advanced/#enabling-legacy-iptables-on-raspbian-buster">https://rancher.com/docs/k3s/latest/en/advanced/#enabling-legacy-iptables-on-raspbian-buster</a> to set up iptables correctly and <a href="https://rancher.com/docs/k3s/latest/en/advanced/#enabling-cgroups-for-raspbian-buster">https://rancher.com/docs/k3s/latest/en/advanced/#enabling-cgroups-for-raspbian-buster</a> to set up cgroups correctly.</p> <p>Before installing on the (virtual) worker nodes, follow <a href="https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-alpine-linux-setup">https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-alpine-linux-setup</a></p> <h3 id="installing-the-control-plane"> <a href="#installing-the-control-plane" class="anchor-heading" aria-labelledby="installing-the-control-plane"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installing the control-plane </h3> <p>Unfortunately, the easiest way to install k3s with systemd is running random scripts from the internet…</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-i</span>
apt <span class="nb">install</span> <span class="nt">-y</span> curl
curl <span class="nt">-sfL</span> https://get.k3s.io | sh -
</code></pre></div></div> <h2 id="prevent-pods-running-on-control-plane"> <a href="#prevent-pods-running-on-control-plane" class="anchor-heading" aria-labelledby="prevent-pods-running-on-control-plane"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prevent pods running on control plane </h2> <p>It’s generally a bad idea to run workloads on your control plane, especially in this case as our workloads with be x86 but the control plane is ARM64.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl taint nodes node-0001 node-role.kubernetes.io/master<span class="o">=</span><span class="nb">true</span>:NoSchedule
</code></pre></div></div> <h3 id="adding-worker-nodes"> <a href="#adding-worker-nodes" class="anchor-heading" aria-labelledby="adding-worker-nodes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Adding worker nodes </h3> <p>Pretty simple, <a href="https://rancher.com/docs/k3s/latest/en/quick-start/#install-script">full guide here.</a></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apk add curl <span class="o">&amp;&amp;</span> curl <span class="nt">-sfL</span> https://get.k3s.io | <span class="nv">K3S_URL</span><span class="o">=</span>https://node-001:6443 <span class="nv">K3S_TOKEN</span><span class="o">=</span>SomeTokenFromControlPlane sh -
</code></pre></div></div> <p>With this, the x86_64 workers nodes should be added the cluster. Each node should have a unique hostname and be connectable on that hostname from all nodes.</p> <h2 id="success"> <a href="#success" class="anchor-heading" aria-labelledby="success"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Success? </h2> <p>If you’re successful, you should have a working k3s cluster with workloads running on x86 (slowly!)</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@node-001:~ <span class="nv">$ </span>kubectl get nodes
NAME                            STATUS   ROLES                  AGE    VERSION
node-001                        Ready    control-plane,master   105m   v1.21.5+k3s2
k3s-002                         Ready    control-plane,master   100m   v1.21.5+k3s2
k3s-003                         Ready    control-plane,master   90m   v1.21.5+k3s2
k3s-004                         Ready    control-plane,master   80m   v1.21.5+k3s2
k3s-005                         Ready    control-plane,master   70m   v1.21.5+k3s2
</code></pre></div></div> <h2 id="why-you-shouldnt-do-this"> <a href="#why-you-shouldnt-do-this" class="anchor-heading" aria-labelledby="why-you-shouldnt-do-this"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why you shouldn’t do this </h2> <p>Over 1.5 cores of the Pi is used by <em>k3s</em>, never mind the workloads we want to run!</p> <p>Here’s a simple <a href="https://github.com/reactive-tech/kubegres">pod</a> which didn’t manage to start, even after 5 mins due to the CPU limitations.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@node-001:~ <span class="nv">$ </span>kubectl get pod <span class="nt">-w</span>
NAME                                              READY   STATUS              RESTARTS   AGE
kubegres-controller-manager-75b6765589-kvr97      1/2     ContainerCreating   0          4m54s
</code></pre></div></div> <h2 id="conclusions"> <a href="#conclusions" class="anchor-heading" aria-labelledby="conclusions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conclusions </h2> <p>Don’t run x86 on Pis, especially not on kubernetes! They just aren’t fast enough (yet)</p> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2021 Richard Finlay Tweed. All rights reserved. All views expressed are my own</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
