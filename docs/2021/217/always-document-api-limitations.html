<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Slack-mojis, and why documenting API limitations helps! | Tales from Prod</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Slack-mojis, and why documenting API limitations helps!" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Slackmojis and API limits During a “discussion” on our slack channel about long… thonks, a question occurred - “Just how many slackmojis can be sent in a slack message?”" /> <meta property="og:description" content="Slackmojis and API limits During a “discussion” on our slack channel about long… thonks, a question occurred - “Just how many slackmojis can be sent in a slack message?”" /> <link rel="canonical" href="https://tales.fromprod.com/2021/217/always-document-api-limitations.html" /> <meta property="og:url" content="https://tales.fromprod.com/2021/217/always-document-api-limitations.html" /> <meta property="og:site_name" content="Tales from Prod" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-08-05T21:00:00+01:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Slack-mojis, and why documenting API limitations helps!" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-08-05T21:00:00+01:00","datePublished":"2021-08-05T21:00:00+01:00","description":"Slackmojis and API limits During a “discussion” on our slack channel about long… thonks, a question occurred - “Just how many slackmojis can be sent in a slack message?”","headline":"Slack-mojis, and why documenting API limitations helps!","mainEntityOfPage":{"@type":"WebPage","@id":"https://tales.fromprod.com/2021/217/always-document-api-limitations.html"},"url":"https://tales.fromprod.com/2021/217/always-document-api-limitations.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Tales from Prod </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="/" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/categories/" class="nav-list-link">Categories</a></li><li class="nav-list-item"><a href="/useful-resources.html" class="nav-list-link">Useful resources</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Tales from Prod" aria-label="Search Tales from Prod" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="slackmojis-and-api-limits"> <a href="#slackmojis-and-api-limits" class="anchor-heading" aria-labelledby="slackmojis-and-api-limits"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Slackmojis and API limits </h1> <p>During a “discussion” on our slack channel about long… thonks, a question occurred - “Just how many slackmojis can be sent in a slack message?”</p> <h2 id="to-the-docs"> <a href="#to-the-docs" class="anchor-heading" aria-labelledby="to-the-docs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> To the docs! </h2> <p>Slack <a href="https://api.slack.com/changelog/2018-04-truncating-really-long-messages">document</a> that the max message length is <em>40,000 characters</em>.</p> <p>Given this, and that you can declare a slackmoji with <code class="language-plaintext highlighter-rouge">:slackmoji:</code> we should be able to send 40,000/(len(:slackmoji:)) right…?</p> <p>Okay, let’s generate that message, and then paste it in the text box</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s1">'print(":longthonk1:" + ":longthonk2::longthonk3::longthonk4:" * ((40000- len(":longthonk1:") - len(":longthonk5:") )// len(":longthonk2::longthonk3::longthonk4:")) + ":longthonk5:")'</span>
</code></pre></div></div> <p>Also, turns out <code class="language-plaintext highlighter-rouge">xargs -J</code> can’t interpolate 40k characters, and <code class="language-plaintext highlighter-rouge">xargs -I</code> can only do even fewer. The <code class="language-plaintext highlighter-rouge">-J</code> doesn’t throw an error, it’ll only put the characters afterwards as if that flag is ignored. Who knew?</p> <h3 id="what-happened"> <a href="#what-happened" class="anchor-heading" aria-labelledby="what-happened"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What happened </h3> <p>So, you can paste this in and wait a <em>long</em> time, as the slack client seems to parse the message for each slackmoji and then render it leading to the following great gif in real time</p> <p><img src="/static/2021-08-05-always-document-api-limitations/slow-decoding.gif" alt="Slack slowly parsing the message and rendering one slackmoji at a time" width="610" /></p> <p>Once it renders the message, nothing happens if you click the send button.</p> <h3 id="now-what"> <a href="#now-what" class="anchor-heading" aria-labelledby="now-what"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Now what? </h3> <p>Well, let’s assume that the web client wasn’t up to the challenge of our message (sorry devs). Why don’t we try the API ourselves?</p> <h2 id="having-fun-at-the-expense-of-the-slack-api"> <a href="#having-fun-at-the-expense-of-the-slack-api" class="anchor-heading" aria-labelledby="having-fun-at-the-expense-of-the-slack-api"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Having fun at the expense of the slack API </h2> <p>I didn’t want to create an app for this, so what do to? Using user API tokens for the API is no longer supported…. Or is it?</p> <h3 id="getting-api-calls-to-work-with-user-tokens"> <a href="#getting-api-calls-to-work-with-user-tokens" class="anchor-heading" aria-labelledby="getting-api-calls-to-work-with-user-tokens"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Getting API calls to work with user tokens </h3> <p>I got the network calls while sending a message and started stripping parts from it until I found the minimum that works…</p> <p>Turns out all you need is the user token, and the cookies (Ie everything in the value of the <code class="language-plaintext highlighter-rouge">Cookie:</code> request header). If you don’t include the cookie you’ll get an unauthorised response.</p> <p><code class="language-plaintext highlighter-rouge">{"ok": false, "error": "invalid_auth"}</code></p> <h3 id="how-are-slackmojis-represented"> <a href="#how-are-slackmojis-represented" class="anchor-heading" aria-labelledby="how-are-slackmojis-represented"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How are slackmojis represented? </h3> <p>After further experimentation, it turns out the API actually considers slackmojis to be emojis, and they have to be in a list of blocks. This makes it a bit harder to work out the max message size (and meet it)</p> <h2 id="findings"> <a href="#findings" class="anchor-heading" aria-labelledby="findings"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Findings </h2> <h3 id="request-failed-successfully-or-unexpected-errors"> <a href="#request-failed-successfully-or-unexpected-errors" class="anchor-heading" aria-labelledby="request-failed-successfully-or-unexpected-errors"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Request failed successfully or “Unexpected Errors” </h3> <p>If you try to send too many slackmojis in a message, you’ll get a 200 and a response of <code class="language-plaintext highlighter-rouge">{"ok":false,"error":"msg_blocks_too_long"}</code> which is frustrating. At least give me a <code class="language-plaintext highlighter-rouge">400</code> error!</p> <p>This error has the wonderful explanation in the <a href="https://api.slack.com/methods/chat.postMessage#errors">docs</a>. <code class="language-plaintext highlighter-rouge">msg_blocks_too_long [hidden] msg blocks too long (generated)</code></p> <p>Slack support were lovely, but essentially wondering why would I do such a thing, and suggested I just don’t send as many emojis 😔</p> <h3 id="max-length--max-length"> <a href="#max-length--max-length" class="anchor-heading" aria-labelledby="max-length--max-length"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Max length != max length </h3> <p>The number of slackmojis you can send seems to vary, though on what I’m not sure. The message needs to be less than 40k characters long, but it also seems to depend on which slackmoji you want to send. It seems that you can only send about half as many animated slackmojis… Which seems to be for the best. The client gets <em>slow</em> when you send 5 messages, each with <em>only</em> 1,100 animated slackmojis.</p> <h2 id="tldr"> <a href="#tldr" class="anchor-heading" aria-labelledby="tldr"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> TLDR </h2> <p>You should put sensible limits and validation on your API requests (+1 Slack) and document them (-1 Slack)</p> <p>Why? Someone will try to push them at some point, and it’s not always someone wanting to have a bit of innocent fun in a slack thread…</p> <p>Here’s a gif of the laggy aftermath</p> <p><img src="/static/2021-08-05-always-document-api-limitations/laggy-rendering.gif" alt="Slack rendering over 2,000 animated slackmojis judderingly" width="720" /></p> <h2 id="sample-code"> <a href="#sample-code" class="anchor-heading" aria-labelledby="sample-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sample code </h2> <p>Please only use this for innocent fun, where you have permission as it can really slow a slack client if it has to render too many slackmojis.</p> <p>This snippet is provided under an <a href="https://github.com/git/git-scm.com/blob/main/MIT-LICENSE.txt">MIT license</a> and I hold no responsibility for how you choose to use it.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">http.client</span><span class="p">,</span> <span class="n">urllib</span><span class="p">.</span><span class="n">parse</span>

<span class="c1"># Replace
# TOKEN with your bearer token like xoxc-
# COOKIE with your browser cookies, you can get this from the network tab
# CHANNEL with the channel, something like DD95R8TDY, it'll be the second level in your browser ie $2 in https://app.slack.com/client/$1/$2
</span>
<span class="c1"># If you want to reply to a thread replace
# THREAD with the thread_ts from inspecting the URL of the thread it'll be the fourth level in your browser ie $3 in  https://app.slack.com/client/$1/$2/thread/$2-$3
# otherwise remove "thread_ts": "THREAD",
</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="s">"slack.com"</span><span class="p">)</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Content-type"</span><span class="p">:</span> <span class="s">"application/json; charset=utf-8"</span><span class="p">,</span> <span class="s">"Authorization"</span><span class="p">:</span> <span class="s">"Bearer TOKEN"</span><span class="p">,</span> <span class="s">"cookie"</span><span class="p">:</span> <span class="s">"COOKIE"</span><span class="p">}</span>

<span class="n">extrathonk</span> <span class="o">=</span> <span class="s">',{"type":"emoji","name":"thonking-intensifies"},'</span> <span class="o">*</span> <span class="p">((</span><span class="mi">40600</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">'{"type":"emoji","name":"thonking-intensifies"}'</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s">',{"type":"emoji","name":"thonking-intensifies"}'</span><span class="p">)</span> <span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="s">',{"type":"emoji","name":"thonking-intensifies"},'</span><span class="p">))</span> <span class="o">+</span> <span class="s">',{"type":"emoji","name":"thonking-intensifies"}'</span>
<span class="n">body</span> <span class="o">=</span> <span class="s">'{"channel": "CHANNEL", "thread_ts": "THREAD",  "blocks": [{"type":"rich_text","elements":[{"type":"rich_text_section","elements":[{"type":"text","text":"‎"}, %s]}]}]}'</span> <span class="o">%</span> <span class="n">extrathonk</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

<span class="n">conn</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s">"POST"</span><span class="p">,</span> <span class="s">"/api/chat.postMessage"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">getresponse</span><span class="p">()</span>

<span class="c1"># response.reason Required as Slack will return a 200, even if your message fails due to "msg_blocks_too_long".
</span><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>

</code></pre></div></div> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2021 Richard Finlay Tweed. All rights reserved. All views expressed are my own</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
