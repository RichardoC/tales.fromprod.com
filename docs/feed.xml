<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.3">Jekyll</generator><link href="https://tales.fromprod.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://tales.fromprod.com/" rel="alternate" type="text/html" /><updated>2023-07-26T23:30:02+01:00</updated><id>https://tales.fromprod.com/feed.xml</id><title type="html">Tales from Prod</title><subtitle>Welcome to Richard Finlay Tweed&apos;s thoughts on Cloud Native Software, Kubernetes, Production and whatever else he&apos;s been tinkering with.</subtitle><entry><title type="html">Bulk deleting tickets in Jira</title><link href="https://tales.fromprod.com/2023/177/bulk-deleting-in-jira.html" rel="alternate" type="text/html" title="Bulk deleting tickets in Jira" /><published>2023-06-26T21:00:00+01:00</published><updated>2023-06-26T21:00:00+01:00</updated><id>https://tales.fromprod.com/2023/177/bulk-deleting-in-jira</id><content type="html" xml:base="https://tales.fromprod.com/2023/177/bulk-deleting-in-jira.html">&lt;h1 id=&quot;bulk-deleting-tickets-in-jira&quot;&gt;Bulk deleting tickets in Jira&lt;/h1&gt;
&lt;p&gt;For the sake of argument, say your automation developers have a test project for testing their tooling which automatically raises a jira ticket when it finds something a human needs to deal with. This is fantastic, until a few months later when the tooling chnages, and the 10,000s of old tickets are no longer “correct” in the test project.&lt;/p&gt;

&lt;p&gt;So, you want to clean up the old tickets, so only the new “valid” tickets exist in this test project.&lt;/p&gt;

&lt;h2 id=&quot;approach-1---use-the-bulk-edit-functionality&quot;&gt;Approach 1 - use the bulk edit functionality&lt;/h2&gt;

&lt;p&gt;Jira has a &lt;a href=&quot;https://confluence.atlassian.com/jirasoftwareserver/editing-multiple-issues-at-the-same-time-939938937.html&quot;&gt;bulk edit functionality&lt;/a&gt;, that can be used for deleting issues. Unfortunately it only allows 1,000 issues at a time but surely running that 10 ish times is fine… right?&lt;/p&gt;

&lt;h3 id=&quot;problem&quot;&gt;Problem&lt;/h3&gt;

&lt;p&gt;It takes 12 minutes to delete the 1,000 issues. Sitting here for multiple hours triggering bulk delete through the UI isn’t how you want to spend you day.&lt;/p&gt;

&lt;h2 id=&quot;approach-2---use-the-apis&quot;&gt;Approach 2 - use the APIs&lt;/h2&gt;

&lt;p&gt;Atlassian have many APIs for Jira, and &lt;a href=&quot;https://developer.atlassian.com/cloud/jira/platform/rest/v3/api-group-issues/#api-rest-api-3-issue-issueidorkey-delete&quot;&gt;reasonable docs&lt;/a&gt; for them as well!&lt;/p&gt;

&lt;h3 id=&quot;the-good&quot;&gt;The good&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Jira has APIs&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;the-bad&quot;&gt;The bad&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Jira doesn’t have a &lt;a href=&quot;https://community.developer.atlassian.com/t/jira-rest-api-endpoint-for-bulk-delete-issues/55806&quot;&gt;bulk delete API&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;Jira won’t necessarily give you all matching issues from an issue search API call, depending on how much data is in each issue&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;the-how&quot;&gt;The how&lt;/h3&gt;

&lt;p&gt;Assuming the following&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Your atlassian cloud instance URL is &lt;a href=&quot;https://example.atlassian.net&quot;&gt;https://example.atlassian.net&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;You’re using bash on a *nix&lt;/li&gt;
  &lt;li&gt;You have issued a JIRA API token from &lt;a href=&quot;https://id.atlassian.com/manage-profile/security&quot;&gt;https://id.atlassian.com/manage-profile/security&lt;/a&gt; and exported it as JIRA_API_TOKEN in your shell&lt;/li&gt;
  &lt;li&gt;You’ve exported your atlassian user email as JIRA_EMAIL&lt;/li&gt;
  &lt;li&gt;You have a JQL query that matches the issues you want to delete, and ONLY the issues you want to delete and have exported it (URL encoded) as JIRA_JQL&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Example URL encoded JQL is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;project%20%3D%20TOY%20AND%20issuetype%20%3D%20Vulnerability%20ORDER%20BY%20created%20DESC&lt;/code&gt; which matches all vulnerabilty issues in a project called TOY&lt;/p&gt;

&lt;h3 id=&quot;final-script&quot;&gt;Final script&lt;/h3&gt;

&lt;p&gt;OBLIGATORY WARNING - this will delete all issues which match the JQL, and ALL subtasks use with caution!&lt;/p&gt;

&lt;p&gt;This script will attempt to delete the issues, with 12 parallel threads. It has zero error handlin or backoff so you are likely to get &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;429 - Too many requests&lt;/code&gt; and should cancel the script and wait a few minutes before resuming.
During this time your user will be unable to use the Jira webapp as well, as it’s your user that gets rate limited, not the API token.&lt;/p&gt;

&lt;p&gt;You may also have to rerun this script multiple times if you have more than ~ 10,000 issues, as this doesn’t follow any pagination.&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;curl --request GET \
  --url &quot;https://example.atlassian.net/rest/api/3/search?maxResults=20000&amp;amp;fields=id&amp;amp;jql=$&lt;/span&gt;JIRA_JQL&lt;span class=&quot;s2&quot;&gt;&quot;  &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
  --user &quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$JIRA_EMAIL&lt;/span&gt;:&lt;span class=&quot;nv&quot;&gt;$JIRA_API_TOKEN&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot; &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;
  --header &apos;Accept: application/json&apos; | jq -r &apos;.issues[].id&apos;  | xargs -P12 -I{} bash -c &apos;curl --request DELETE   --url &apos;https://example.atlassian.net/rest/api/3/issue/{}?deleteSubtasks=true&apos;  --user &quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$JIRA_EMAIL&lt;/span&gt;:&lt;span class=&quot;nv&quot;&gt;$JIRA_API_TOKEN&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot; &amp;amp;&amp;amp; echo &quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt; completed&lt;span class=&quot;s2&quot;&gt;&quot; || echo &quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt; failed&lt;span class=&quot;s2&quot;&gt;&quot;&apos;
&lt;/span&gt;&lt;span class=&quot;go&quot;&gt;14054 completed
14050 completed
&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;...
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="Jira" /><category term="APIs" /><category term="Atlassian" /><summary type="html">Bulk deleting tickets in Jira For the sake of argument, say your automation developers have a test project for testing their tooling which automatically raises a jira ticket when it finds something a human needs to deal with. This is fantastic, until a few months later when the tooling chnages, and the 10,000s of old tickets are no longer “correct” in the test project.</summary></entry><entry><title type="html">Getting started with LLMs locally</title><link href="https://tales.fromprod.com/2023/099/getting-started-with-llms-locally.html" rel="alternate" type="text/html" title="Getting started with LLMs locally" /><published>2023-04-09T20:00:00+01:00</published><updated>2023-04-09T20:00:00+01:00</updated><id>https://tales.fromprod.com/2023/099/getting-started-with-llms-locally</id><content type="html" xml:base="https://tales.fromprod.com/2023/099/getting-started-with-llms-locally.html">&lt;h1 id=&quot;getting-started-with-llms-locally&quot;&gt;Getting started with LLMs locally&lt;/h1&gt;

&lt;p&gt;So you’ve heard all the hype about Large Language Models (LLM) and want to run one yourself locally. This guide details how&lt;/p&gt;

&lt;h2 id=&quot;why-would-i-want-to-run-it-locally&quot;&gt;Why would I want to run it locally?&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;You want to peer behind the curtain of what’s actually happening&lt;/li&gt;
  &lt;li&gt;You don’t want you prompts to be sent to a third party&lt;/li&gt;
  &lt;li&gt;You want to test the LLM with sensitive intellectual property&lt;/li&gt;
  &lt;li&gt;Why not?&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Ubuntu (ish)&lt;/li&gt;
  &lt;li&gt;Huge amounts of ram, or a huge &lt;a href=&quot;https://help.ubuntu.com/community/SwapFaq&quot;&gt;swapfile/swap&lt;/a&gt; partition. 32GB+ is commonly required&lt;/li&gt;
  &lt;li&gt;Python experience&lt;/li&gt;
  &lt;li&gt;A fast internet connection&lt;/li&gt;
  &lt;li&gt;50GB+ free storage space&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;getting-started-guide&quot;&gt;Getting started guide&lt;/h2&gt;

&lt;p&gt;Install &lt;a href=&quot;https://docs.docker.com/engine/install/debian/&quot;&gt;Docker&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you have an nvidia GPU configured with cuda you might be able to follow &lt;a href=&quot;https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/user-guide.html&quot;&gt;https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/user-guide.html&lt;/a&gt; to use GPU acceleration.&lt;/p&gt;

&lt;p&gt;Install git and git lfs and set it up.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;git git-lfs
git lfs &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Download the docker image with all the tools you need, this is ~ 10GB&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker pull huggingface/transformers-all-latest-gpu
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Discover the model you want to play with on Hugging Face such as &lt;a href=&quot;https://huggingface.co/cerebras/Cerebras-GPT-2.7B&quot;&gt;https://huggingface.co/cerebras/Cerebras-GPT-2.7B&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can download it by cloning the git repo (~11GB)&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://huggingface.co/cerebras/Cerebras-GPT-2.7B
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now to run the model&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker run &lt;span class=&quot;nt&quot;&gt;-it&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt;  &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;:/model docker.io/huggingface/transformers-all-latest-gpu
&lt;span class=&quot;c&quot;&gt;# From now all commands are inside the container&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /model
&lt;span class=&quot;c&quot;&gt;# start a python interpreter to use&lt;/span&gt;
python3
&lt;span class=&quot;c&quot;&gt;# from now all commands are inside the python interpreter&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;actually-playing-with-the-model&quot;&gt;Actually playing with the model&lt;/h3&gt;

&lt;p&gt;Now for the Python, in the REPL terminal.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# This stage will take a while as it loads the model into ram, and may lead to it getting OOMK
&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;transformers&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AutoTokenizer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AutoModelForCausalLM&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;tokenizer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AutoTokenizer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;from_pretrained&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;./Cerebras-GPT-2.7B&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;model&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AutoModelForCausalLM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;from_pretrained&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;./Cerebras-GPT-2.7B&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# convenience function to wrap the steps from prompt to reponse
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;model_on_prompt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;inputs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tokenizer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;return_tensors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;pt&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;outputs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;model&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;generate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;**&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;inputs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;num_beams&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;max_new_tokens&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;early_stopping&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                        &lt;span class=&quot;n&quot;&gt;no_repeat_ngram_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;text_output&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tokenizer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;batch_decode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;outputs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;skip_special_tokens&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;True&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;text_output&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Now to run the model on your prompt
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;model_on_prompt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;What can I use LLMs for?&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="ML" /><category term="Python" /><category term="Docker" /><summary type="html">Getting started with LLMs locally</summary></entry><entry><title type="html">VPN over VPN on OpenWrt</title><link href="https://tales.fromprod.com/2022/347/VPN-over-VPN-on-Openwrt.html" rel="alternate" type="text/html" title="VPN over VPN on OpenWrt" /><published>2022-12-13T19:00:00+00:00</published><updated>2022-12-13T19:00:00+00:00</updated><id>https://tales.fromprod.com/2022/347/VPN-over-VPN-on-Openwrt</id><content type="html" xml:base="https://tales.fromprod.com/2022/347/VPN-over-VPN-on-Openwrt.html">&lt;h1 id=&quot;vpn-over-vpn-on-openwrt-on-one-device&quot;&gt;VPN over VPN on Openwrt on one device&lt;/h1&gt;

&lt;p&gt;OpenWrt has reasonable &lt;a href=&quot;https://openwrt.org/docs/guide-user/services/vpn/wireguard/client&quot;&gt;guides&lt;/a&gt; on using your router as a WireGuard client but it’s missing a how to on running VPN over VPN. This article will close that gap&lt;/p&gt;

&lt;h2 id=&quot;why-run-vpn-over-vpn&quot;&gt;Why run VPN over VPN?&lt;/h2&gt;

&lt;p&gt;This guide exists because a certain UK ISP has terrible peering with another continent. A mitigation for this issue was to send traffic first to a UK VPN server with much better peering connections, and then send the actual VPN traffic to that other continent to appear there for the “first time”&lt;/p&gt;

&lt;h3 id=&quot;terminology&quot;&gt;Terminology&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;OuterVPN - innervpn.example.com - The VPN closest to you, that you’re using to take advantage of the better peering. The traffic exiting here is for the second VPN server.&lt;/li&gt;
  &lt;li&gt;InnerVPN - outervpn.example.com - The VPN on another continent. The traffic existing here is the normal traffic you wanted to go over a VPN.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;why-do-vpn-over-vpn-on-one-device&quot;&gt;Why do VPN over VPN on one device?&lt;/h3&gt;

&lt;p&gt;VPN over VPN is most commonly done by having one device do the connection to Outer VPN, and another (having the lan of the first device as its WAN) do the connection do the connection to InnerVPN. This is common because most routers are fairly slow and doing VPN over VPN slows the network performance too much. It’s also simpler to configure and debug.&lt;/p&gt;

&lt;p&gt;However, there are now reasonably powerful devices like the Raspberry Pi 4 which can do this VPN over VPN (WireGuard) and achieve &amp;gt; 200Mb/s. This means rather than needing so many devices you can do it all on one and only have to maintain one device.&lt;/p&gt;

&lt;h2 id=&quot;how-to-set-up-the-initial-wireguard-connection&quot;&gt;How to set up the initial WireGuard connection?&lt;/h2&gt;

&lt;p&gt;Follow this guide from &lt;a href=&quot;https://www.azirevpn.com/support/guides/router/openwrt/wireguard&quot;&gt;azirevpn&lt;/a&gt; as it’s one of the better ones.&lt;/p&gt;

&lt;h2 id=&quot;now-i-have-my-inital-connection-how-to-do-i-do-vpn-over-vpn&quot;&gt;Now I have my inital connection, how to do I do VPN over VPN?&lt;/h2&gt;

&lt;p&gt;Assuming you have your Wireguard.conf file, you can follow that guide again but naming the new interface differently. Then, you should obtain the IP address of the InnerVPN server. These can be obtained via the following&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;dig outervpn.example.com

&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &amp;lt;&amp;lt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; DiG 9.18.1-1ubuntu1.2-Ubuntu &amp;lt;&amp;lt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; outervpn.example.com
&lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt; global options: +cmd
&lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt; Got answer:
&lt;span class=&quot;p&quot;&gt;;;&lt;/span&gt; -&amp;gt;&amp;gt;HEADER&lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;opcode&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;: QUERY, status: NOERROR, id: 49846
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;vpn.example.com.	IN	A

;; ANSWER SECTION:
outervpn.example.com. 60 IN	A	192.0.2.240
outervpn.example.com. 60 IN	A	192.0.0.240

;; Query time: 32 msec
;; SERVER: 127.0.0.53#53(127.0.0.53) (UDP)
;; WHEN: Tue Dec 13 18:56:44 GMT 2022
;; MSG SIZE  rcvd: 89
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once you have the IP addresses, you should edit the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Allowed IPs&lt;/code&gt; of the peer of OuterVPN to remove &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0.0.0.0/0&lt;/code&gt; and add the IPs obtained via the DNS lookup, each suffixed with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/32&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Hit Save and Save and Apply, and you should be in business.&lt;/p&gt;

&lt;p&gt;You can confirm this is working as expected by pinging the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;innervpn.example.com&lt;/code&gt; and seeing that this has a faster response than pinging &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;outervpn.example.com&lt;/code&gt; and that both of these are faster than pinging a random server. If this isn’t true, something’s configured wrong.&lt;/p&gt;

&lt;h2 id=&quot;why-does-this-work&quot;&gt;Why does this work?&lt;/h2&gt;

&lt;p&gt;Routers send traffic to the most specific route in their routing table, and then fall back to their default route.&lt;/p&gt;

&lt;p&gt;In the configuration above, we have a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/32&lt;/code&gt; (exact IP address) route for the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;outervpn.example.com&lt;/code&gt; IPs, which is over the OuterVPN tunnel.&lt;/p&gt;

&lt;p&gt;For your normal traffic, it will go over the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0.0.0.0/0&lt;/code&gt; route which goes over the InnerVPN tunnel.&lt;/p&gt;

&lt;p&gt;Your traffic to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;innervpn.example.com&lt;/code&gt; will go via the default route and out over your normal internet.&lt;/p&gt;

&lt;h2 id=&quot;gotchas&quot;&gt;Gotchas&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Route Allowed IPs&lt;/code&gt; is actually in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Peer Configuration&lt;/code&gt; of the WireGuard interface settings on Luci rather than the interface itself. This must be set to true for the routes to be created properly&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;MTU&lt;/code&gt; being misconfigured on each interface is a common reason for slowdowns/random latency. Ensure that the MTU of your first tunnel is at most (line MTU - 80) and the second tunnel is at most (first tunnel MTU - 80). 80 obtained from &lt;a href=&quot;https://projectcalico.docs.tigera.io/networking/mtu#determine-mtu-size&quot;&gt;here&lt;/a&gt;. This is particularly relevant as WireGuard sets the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Don&apos;t Fragment&lt;/code&gt; bit on its packets, which can cause high packetloss.&lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><category term="OpenWrt" /><category term="VPN" /><category term="WireGuard" /><summary type="html">VPN over VPN on Openwrt on one device</summary></entry><entry><title type="html">Why LIST is a scary permission on Kubernetes</title><link href="https://tales.fromprod.com/2022/202/Why-Listing-Is-Scary_On-K8s.html" rel="alternate" type="text/html" title="Why LIST is a scary permission on Kubernetes" /><published>2022-07-21T20:00:00+01:00</published><updated>2022-07-21T20:00:00+01:00</updated><id>https://tales.fromprod.com/2022/202/Why-Listing-Is-Scary_On-K8s</id><content type="html" xml:base="https://tales.fromprod.com/2022/202/Why-Listing-Is-Scary_On-K8s.html">&lt;h1 id=&quot;why-list-is-a-scary-permission-on-kubernetes&quot;&gt;Why LIST is a scary permission on Kubernetes&lt;/h1&gt;

&lt;p&gt;The list response contains all items in full, not just their name. This means the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;list&lt;/code&gt; permission should never be given to a role that doesn’t already have the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;get&lt;/code&gt; permission.&lt;/p&gt;

&lt;h2 id=&quot;example-misuse&quot;&gt;Example misuse&lt;/h2&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
&lt;span class=&quot;c&quot;&gt;# Create example A, which can only list secrets in the default namespace&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# It does not have the GET permission&lt;/span&gt;
kubectl create serviceaccount only-list-secrets-sa
kubectl create role only-list-secrets-role &lt;span class=&quot;nt&quot;&gt;--verb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;list &lt;span class=&quot;nt&quot;&gt;--resource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;secrets
kubectl create rolebinding only-list-secrets-default-ns &lt;span class=&quot;nt&quot;&gt;--role&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;only-list-secrets-role &lt;span class=&quot;nt&quot;&gt;--serviceaccount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default:only-list-secrets-sa
&lt;span class=&quot;c&quot;&gt;# Now to impersonate that service account&lt;/span&gt;
kubectl proxy &amp;amp;
&lt;span class=&quot;c&quot;&gt;# Create a secret to get&lt;/span&gt;
kubectl create secret generic abc
&lt;span class=&quot;c&quot;&gt;# Prove we cannot get that secret&lt;/span&gt;
curl http://127.0.0.1:8001/api/v1/namespaces/default/secrets/abc &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Authorization: Bearer &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;kubectl &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; default get secrets &lt;span class=&quot;nt&quot;&gt;-ojson&lt;/span&gt; | jq &lt;span class=&quot;s1&quot;&gt;&apos;.items[]| select(.metadata.annotations.&quot;kubernetes.io/service-account.name&quot;==&quot;only-list-secrets-sa&quot;)| .data.token&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&quot;&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;base64&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;kind&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Status&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;apiVersion&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;v1&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;metadata&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Failure&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;message&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;secrets &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;abc&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; is forbidden: User &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;system:serviceaccount:default:only-list-secrets-sa&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; cannot get resource &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;secrets&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; in API group &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; in the namespace &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;reason&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;Forbidden&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;details&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;abc&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;kind&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;secrets&quot;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;code&quot;&lt;/span&gt;: 403
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Now to get all secrets in the default namespace, despite not having &quot;get&quot; permission&lt;/span&gt;
curl http://127.0.0.1:8001/api/v1/namespaces/default/secrets?limit&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;500 &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Authorization: Bearer &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;kubectl &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; default get secrets &lt;span class=&quot;nt&quot;&gt;-ojson&lt;/span&gt; | jq &lt;span class=&quot;s1&quot;&gt;&apos;.items[]| select(.metadata.annotations.&quot;kubernetes.io/service-account.name&quot;==&quot;only-list-secrets-sa&quot;)| .data.token&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;tr&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&quot;&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;base64&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;kind&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;SecretList&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;apiVersion&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;v1&quot;&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;metadata&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;selfLink&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;/api/v1/namespaces/default/secrets&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;resourceVersion&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;17718246&quot;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
  &lt;span class=&quot;s2&quot;&gt;&quot;items&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
  REDACTED : REDACTED
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Cleanup&lt;/span&gt;
kubectl delete serviceaccount only-list-secrets-sa
kubectl delete role only-list-secrets-role &lt;span class=&quot;nt&quot;&gt;--verb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;list &lt;span class=&quot;nt&quot;&gt;--resource&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;secrets
kubectl delete rolebinding only-list-secrets-default-ns &lt;span class=&quot;nt&quot;&gt;--role&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;only-list-secrets-role &lt;span class=&quot;nt&quot;&gt;--serviceaccount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;default:only-list-secrets-sa
kubectl delete secret abc
&lt;span class=&quot;c&quot;&gt;# Kill backgrounded kubectl proxy&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;kill&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;jobs&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;kubectl proxy&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;cut&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; 2| &lt;span class=&quot;nb&quot;&gt;cut&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; 1&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="Kubernetes" /><category term="APIs" /><summary type="html">Why LIST is a scary permission on Kubernetes</summary></entry><entry><title type="html">Attempt 2 - Managing Google Groups via the API, aka what they don’t want you to do!</title><link href="https://tales.fromprod.com/2022/011/improved-managing-google-groups.html" rel="alternate" type="text/html" title="Attempt 2 - Managing Google Groups via the API, aka what they don’t want you to do!" /><published>2022-01-11T19:00:00+00:00</published><updated>2022-01-11T19:00:00+00:00</updated><id>https://tales.fromprod.com/2022/011/improved-managing-google-groups</id><content type="html" xml:base="https://tales.fromprod.com/2022/011/improved-managing-google-groups.html">&lt;h1 id=&quot;attempt-2---managing-google-groups-via-the-api-despite-their-best-efforts&quot;&gt;Attempt 2 - Managing Google Groups via the API, despite their best efforts&lt;/h1&gt;
&lt;p&gt;Due to some issues with the groupsService.List() (still pending with Google Support) I found a cleaner way to find the groups, by using a lookup based on the group email address.
I have rewritten this guide to use this instead, as it’s a more sensible way of approaching this problem. The old guide will remain as it should work…&lt;/p&gt;

&lt;h2 id=&quot;managing-google-groups-via-the-api-despite-their-best-efforts&quot;&gt;Managing Google Groups via the API, despite their best efforts&lt;/h2&gt;
&lt;p&gt;Google have made it difficult to do this, they somewhat document two different APIs to achieve this, with limited success. This is especially true if you want to use a service account rather than a user API token for the management.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://developers.google.com/admin-sdk/directory/v1/guides/manage-groups&quot;&gt;Using the directory API&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://cloud.google.com/identity/docs/how-to/create-dynamic-groups&quot;&gt;Using the Cloud Identity APIs - newer and seems to be preferred going forward&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;At the time of writing, these are not sufficiently detailed to do more than work out those are the APIs to use. That’s where this guide comes in.&lt;/p&gt;

&lt;h2 id=&quot;what-this-will-help-you-achieve&quot;&gt;What this will help you achieve&lt;/h2&gt;

&lt;p&gt;A golang binary which manages the membership of a Google Group for you. The steps will likely apply to the other language client libraries&lt;/p&gt;

&lt;h2 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;Google Cloud Identity Premium&lt;/li&gt;
  &lt;li&gt;A paid for Google Workspace&lt;/li&gt;
  &lt;li&gt;A Google cloud Service Account (SA)
    &lt;ul&gt;
      &lt;li&gt;An API key for that SA&lt;/li&gt;
      &lt;li&gt;The email address of that SA&lt;/li&gt;
      &lt;li&gt;This SA requires &lt;strong&gt;no permissions at all&lt;/strong&gt; in the cloud console&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;The google group you wish to manage
    &lt;ul&gt;
      &lt;li&gt;You should add the SA’s email address as an “OWNER” of that group, and change the subscription to “no emails” as it can’t receive them.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;dependencies&quot;&gt;Dependencies&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;A source of email addresses to add to your group&lt;/li&gt;
  &lt;li&gt;The &lt;a href=&quot;https://pkg.go.dev/google.golang.org/api@v0.51.0/cloudidentity/v1&quot;&gt;cloud identity client library&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;The &lt;a href=&quot;https://pkg.go.dev/google.golang.org/api@v0.52.0/option&quot;&gt;Google API options library&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The following is example code and won’t compile without changes, and lacks niceties like error handling and retrying in the face of inevitable errors.&lt;/p&gt;

&lt;p&gt;This should provide a clearer understanding of the hierarchy of the Google Groups data model.&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;//Whatever other deps you need go here&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;google.golang.org/api/cloudidentity/v1&quot;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;goption&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;google.golang.org/api/option&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// Variables to replace in this sample (nonworking) code&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// requiredGroup@example.com -&amp;gt; The email address of the google group you care about&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// &quot;a@a.com&quot;, &quot;b@a.com&quot; -&amp;gt; The actual list of emails you want added&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// addDelta -&amp;gt; A function to say which emails need added to the group based on current emails&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// removeDelta -&amp;gt; A function to say which emails need removed from the group based on current emails&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Create your goptions from your credential file.&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// This is the Service Account Key you downloaded during&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// The prerequisites.&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;goptions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;goption&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithCredentialsFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/some/file/location.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;cis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;goptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Next you&apos;ll want to get the group you&apos;re interested in&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// The only way I found was to get all accessible groups&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Then filter for the relevant email address&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;groupsService&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewGroupsService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Different from old verison&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Finding the groupName by using the fact that the GroupKeyId &lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Is actually the email address of the group&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// The group name is a magic thing of format  groups/{group_id}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;groupsServiceLookup&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;groupsService&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lookup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;groupsServiceLookup&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GroupKeyId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ggroupemail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;groupLookupResponse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;groupsServiceLookup&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// If we wanted the group directly&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// reqGroup, err := gs.Get(groupLookupResponse.Name).Do()&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Now to get the membership of the group, so we can see the emails of the current members&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewGroupsMembershipsService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Response containing list of memberships&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;lmr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;groupLookupResponse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Pulling out just the memberships&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;currentMemberships&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lmr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Memberships&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;member&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentMemberships&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// The EntityKey == PreferredMemberKey == the user email&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;member&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PreferredMemberKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;desiredEmails&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;a@a.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;b@a.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;//The following functions aren&apos;t defined, you need to define this logic yourself&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Example if you wish to only add the new emails&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Rather than deal with 409 which you get&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// if the email is already a member&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;additionalEmails&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desiredEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Example if you wish to remove any members who shouldn&apos;t be there&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;emailsToRemove&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;removeDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desiredEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Now to add the new members&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;additionalEmails&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EntityKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;roles&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MembershipRole&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MembershipRole&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;MEMBER&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Despite the docs saying it&apos;s Member by default, we must explicitly set it&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Or you will get ERROR: googleapi: Error 400: resource.roles must be specified, badRequest&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// when trying to create the membership&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PreferredMemberKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Roles&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;roles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;c&quot;&gt;// This part youll want to make retriable&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Any 409&apos;s are &quot;fine&quot; as it means the member already exists&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Using the &quot;Name&quot; found earlier as it&apos;s annoying to create due to format&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;relevantGroup&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;errStr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sprint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Contains&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;errStr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Error 409&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Now to remove the extra members&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Have a horrible loop as there doesn&apos;t seem to be a nice way to get a membership ID...&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// MembershipLookupCall doesn&apos;t exist :(&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;emailsForRemoval&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;

		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentMemberships&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PreferredMemberKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
					&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Encountered error while deleting membership %+v&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
					&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
					&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
				&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="Google" /><category term="APIs" /><category term="Golang" /><category term="Go" /><summary type="html">Attempt 2 - Managing Google Groups via the API, despite their best efforts Due to some issues with the groupsService.List() (still pending with Google Support) I found a cleaner way to find the groups, by using a lookup based on the group email address. I have rewritten this guide to use this instead, as it’s a more sensible way of approaching this problem. The old guide will remain as it should work…</summary></entry><entry><title type="html">Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!</title><link href="https://tales.fromprod.com/2021/342/x86-on-k8s-on-raspberry-pi.html" rel="alternate" type="text/html" title="Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!" /><published>2021-12-08T19:00:00+00:00</published><updated>2021-12-08T19:00:00+00:00</updated><id>https://tales.fromprod.com/2021/342/x86-on-k8s-on-raspberry-pi</id><content type="html" xml:base="https://tales.fromprod.com/2021/342/x86-on-k8s-on-raspberry-pi.html">&lt;h1 id=&quot;running-a-kubernetes-native-x86_64-application-on-raspberry-pis-and-why-you-shouldnt&quot;&gt;Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!&lt;/h1&gt;

&lt;p&gt;While this guide does work, don’t do this. Emulation is &lt;em&gt;slow&lt;/em&gt; and Raspberry Pi CPUs (even overclocked to 2GHz) are slower!&lt;/p&gt;

&lt;p&gt;Also, you have to use x86_64 emulation (rather than KVM) because Pis use an ARM instruction set rather than x86.&lt;/p&gt;

&lt;h2 id=&quot;cpu-benchmark-for-slowness&quot;&gt;CPU benchmark for slowness&lt;/h2&gt;
&lt;p&gt;This benchmark is terrible, but gives an indication of single threaded performance&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#On my work machine&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;time dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/urandom &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/null &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000000 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;100

real	0m4.264s
user	0m0.000s
sys	0m4.264s

&lt;span class=&quot;c&quot;&gt;# On a VM on k3s-005&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/urandom &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/null &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000000 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;100

real 0m 19.08s
user 0m 0.03s
sys 0m 18.94s

&lt;span class=&quot;c&quot;&gt;# Natively on that Pi&lt;/span&gt;
pi@node-005:~ &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;time dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/urandom &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/null &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2000000 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;100

real	0m2.784s
user	0m0.004s
sys	0m2.769s
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;architecture&quot;&gt;Architecture&lt;/h2&gt;

&lt;div align=&quot;center&quot;&gt;x86_64 Application&lt;/div&gt;

&lt;div align=&quot;center&quot;&gt;Kubernetes (k3s)&lt;/div&gt;

&lt;div align=&quot;center&quot;&gt;QEMU x86_64 emulation&lt;/div&gt;

&lt;div align=&quot;center&quot;&gt;Raspberry Pis&lt;/div&gt;

&lt;h2 id=&quot;equipment-in-use&quot;&gt;Equipment in use&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;4 * Pi 4 8GB&lt;/li&gt;
  &lt;li&gt;SSD enclosure per Pi supporting UASP&lt;/li&gt;
  &lt;li&gt;SSD per Pi&lt;/li&gt;
  &lt;li&gt;Ethernet switch&lt;/li&gt;
  &lt;li&gt;A router&lt;/li&gt;
  &lt;li&gt;Power&lt;/li&gt;
  &lt;li&gt;misc cables&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;oss-in-use&quot;&gt;OSs in use&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;Raspbian 64 bit on the Pis&lt;/li&gt;
  &lt;li&gt;Alpine in the x86_64 VMs&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;setting-up-the-pis&quot;&gt;Setting up the Pis&lt;/h2&gt;
&lt;p&gt;We installed 64 bit Raspbian on the SSDs and booted from them.&lt;/p&gt;

&lt;h3 id=&quot;installing-the-dependencies&quot;&gt;Installing the dependencies&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt update &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt upgrade &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; qemu nmon virtinst qemu-utils qemu-system-x86 tmux vim dnsmasq-utils dnsmasq-base iptables libvirt-daemon-system
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;overclocking-the-pis&quot;&gt;Overclocking the Pis&lt;/h3&gt;
&lt;p&gt;The Raspberry Pi doesn’t have the fastest CPU, so we overclocked it to 2GHz and over_voltage 6 to keep the warranty. Full guide &lt;a href=&quot;https://www.seeedstudio.com/blog/2020/02/12/how-to-safely-overclock-your-raspberry-pi-4-to-2-147ghz/&quot;&gt;https://www.seeedstudio.com/blog/2020/02/12/how-to-safely-overclock-your-raspberry-pi-4-to-2-147ghz/&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;setting-up-the-qemu-groups&quot;&gt;Setting up the QEMU groups&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;groupadd libvirt-qemu
groupadd libvirt
groupadd libvirtd
useradd &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; libvirt-qemu libvirt-qemu
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;setting-up-swap-in-case-its-need-since-8gb-ram-isnt-much&quot;&gt;Setting up swap (in case it’s need since 8GB RAM isn’t much)&lt;/h3&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Create and mount swap&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;fallocate &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; 64G /swapfile &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo chmod &lt;/span&gt;600 /swapfile &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mkswap /swapfile &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;swapon /swapfile
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Next add an entry to fstab so that the swap is mounted on boot.&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;su &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;echo &apos;/swapfile swap swap defaults 0 0&apos; &amp;gt;&amp;gt; /etc/fstab&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Next check that trim works on the PI, if it’s working you should get something similar to the following&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;fstrim &lt;span class=&quot;nt&quot;&gt;-av&lt;/span&gt;
/boot: 0 B &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;0 bytes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; trimmed
/: 19.9 GiB &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;21294051328 bytes&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; trimmed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If this fails, you’ll need to follow &lt;a href=&quot;https://www.jeffgeerling.com/blog/2020/enabling-trim-on-external-ssd-on-raspberry-pi&quot;&gt;https://www.jeffgeerling.com/blog/2020/enabling-trim-on-external-ssd-on-raspberry-pi&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Due to the high volume of writes expected since the SSD will be used as RAM, configure TRIM to run frequently to prevent rapid deterioration of the SSD.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# trimming every 2 min:&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vi /lib/systemd/system/fstrim.timer
&lt;span class=&quot;c&quot;&gt;# change:&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Timer]
&lt;span class=&quot;nv&quot;&gt;OnCalender&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;:0/2
&lt;span class=&quot;nv&quot;&gt;AccuracySec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl daemon-reload
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;setting-up-the-bridge-networking-so-the-vms-can-connect-directly-helpful-for-k8s&quot;&gt;Setting up the Bridge networking so the VMs can connect directly (helpful for k8s)&lt;/h3&gt;
&lt;p&gt;Largely following &lt;a href=&quot;https://www.raspberrypi.com/documentation/computers/configuration.html#bridging&quot;&gt;https://www.raspberrypi.com/documentation/computers/configuration.html#bridging&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;su &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;echo &apos;[NetDev]
Name=br0
Kind=bridge
&apos; &amp;gt;&amp;gt; /etc/systemd/network/bridge-br0.netdev&quot;&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;su &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;echo &apos;[Match]
Name=eth0

[Network]
Bridge=br0
&apos; &amp;gt;&amp;gt; /etc/systemd/network/bridge-br0.netdev&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;systemd-networkd

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Next ensure that eth0 is on the bridge network, and it’s the bridge that does dhcp rather than other interfaces&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/dhcpcd.conf
&lt;span class=&quot;c&quot;&gt;# At top add the following, without the #&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# denyinterfaces wlan0 eth0&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# at the very bottom add, without the #&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# interface br0&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Next is to let QEMU use this bridge, largely following &lt;a href=&quot;https://wiki.archlinux.org/title/QEMU#Bridged_networking_using_qemu-bridge-helper&quot;&gt;https://wiki.archlinux.org/title/QEMU#Bridged_networking_using_qemu-bridge-helper&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo mkdir&lt;/span&gt; /etc/qemu

&lt;span class=&quot;c&quot;&gt;# Add all that into a script (run as root):&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#!bin/bash&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOT&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; &amp;gt; /etc/systemd/network/bridge-br0.netdev
[NetDev]
Name=br0
Kind=bridge
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOT

&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOT&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; &amp;gt; /etc/systemd/network/br0-member-eth0.network
[Match]
Name=eth0

[Network]
Bridge=br0
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOT

&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;1s/^/denyinterfaces wlan0 eth0 \n/&apos;&lt;/span&gt; /etc/dhcpcd.conf
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;interface br0&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /etc/dhcpcd.conf

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/etc/qemu&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
  &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /etc/qemu
&lt;span class=&quot;k&quot;&gt;fi
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;allow br0&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/qemu/bridge.conf


&lt;span class=&quot;c&quot;&gt;#then need to execute later&lt;/span&gt;
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;system-networkd

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;running-the-x86-vm&quot;&gt;Running the x86 VM&lt;/h3&gt;
&lt;p&gt;For the VM we used Alpine as it’s a light OS and compatible with k3s. You can choose your download from &lt;a href=&quot;https://alpinelinux.org/downloads/&quot;&gt;https://alpinelinux.org/downloads/&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://dl-cdn.alpinelinux.org/alpine/v3.15/releases/x86_64/alpine-virt-3.15.0-x86_64.iso
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Next you’ll have to create a disk image for the Alpine VM, we created a 128GB sparse image given the size of the SSDs we used.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;qemu-img create &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; qcow2 alpine.qcow2 128G

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now to run the VM, this command must be run from a display because it attempts to open a window. It is possible to do this in a headless fashion, but we couldn’t get that working.
Each VM needs a unique mac address for the networking to work correctly&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;qemu-system-x86_64 &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; alpine-node &lt;span class=&quot;nt&quot;&gt;-drive&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/home/pi/alpine.qcow2 &lt;span class=&quot;nt&quot;&gt;-smp&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;cpus&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4 &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; 60G,slots&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4,maxmem&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;61G &lt;span class=&quot;nt&quot;&gt;-accel&lt;/span&gt; tcg,thread&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi &lt;span class=&quot;nt&quot;&gt;-nic&lt;/span&gt; bridge,br&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;br0,model&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;virtio-net-pci,mac&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;52:54:00:12:34:50
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Exciting options, 
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-accel tcg,thread=multi&lt;/code&gt; enables the VM to use multiple host cores
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;virtio-net-pci&lt;/code&gt; allows a virtual nic that works with the bridge configured.&lt;/p&gt;

&lt;p&gt;You should ensure each of these VMs have a unique hostname, and a static IP in your router. This will make k3s configuration much easier&lt;/p&gt;

&lt;h2 id=&quot;configuring-k3s&quot;&gt;Configuring k3s&lt;/h2&gt;
&lt;p&gt;For our setup, one Pi ran the k3s control plane natively (and didn’t have a VM running) and the other Pis each had a VM running. Those VMs were joined to the k3s cluster as worker nodes.&lt;/p&gt;

&lt;p&gt;Before installing on the control node, follow &lt;a href=&quot;https://rancher.com/docs/k3s/latest/en/advanced/#enabling-legacy-iptables-on-raspbian-buster&quot;&gt;https://rancher.com/docs/k3s/latest/en/advanced/#enabling-legacy-iptables-on-raspbian-buster&lt;/a&gt; to set up iptables correctly and &lt;a href=&quot;https://rancher.com/docs/k3s/latest/en/advanced/#enabling-cgroups-for-raspbian-buster&quot;&gt;https://rancher.com/docs/k3s/latest/en/advanced/#enabling-cgroups-for-raspbian-buster&lt;/a&gt; to set up cgroups correctly.&lt;/p&gt;

&lt;p&gt;Before installing on the (virtual) worker nodes, follow &lt;a href=&quot;https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-alpine-linux-setup&quot;&gt;https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-alpine-linux-setup&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;installing-the-control-plane&quot;&gt;Installing the control-plane&lt;/h3&gt;
&lt;p&gt;Unfortunately, the easiest way to install k3s with systemd is running random scripts from the internet…&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt;
apt &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; curl
curl &lt;span class=&quot;nt&quot;&gt;-sfL&lt;/span&gt; https://get.k3s.io | sh -
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;prevent-pods-running-on-control-plane&quot;&gt;Prevent pods running on control plane&lt;/h2&gt;
&lt;p&gt;It’s generally a bad idea to run workloads on your control plane, especially in this case as our workloads with be x86 but the control plane is ARM64.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl taint nodes node-0001 node-role.kubernetes.io/master&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;:NoSchedule
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;adding-worker-nodes&quot;&gt;Adding worker nodes&lt;/h3&gt;
&lt;p&gt;Pretty simple, &lt;a href=&quot;https://rancher.com/docs/k3s/latest/en/quick-start/#install-script&quot;&gt;full guide here.&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;apk add curl &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-sfL&lt;/span&gt; https://get.k3s.io | &lt;span class=&quot;nv&quot;&gt;K3S_URL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;https://node-001:6443 &lt;span class=&quot;nv&quot;&gt;K3S_TOKEN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;SomeTokenFromControlPlane sh -
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this, the x86_64 workers nodes should be added the cluster. Each node should have a unique hostname and be connectable on that hostname from all nodes.&lt;/p&gt;

&lt;h2 id=&quot;success&quot;&gt;Success?&lt;/h2&gt;
&lt;p&gt;If you’re successful, you should have a working k3s cluster with workloads running on x86 (slowly!)&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@node-001:~ &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;kubectl get nodes
NAME                            STATUS   ROLES                  AGE    VERSION
node-001                        Ready    control-plane,master   105m   v1.21.5+k3s2
k3s-002                         Ready    control-plane,master   100m   v1.21.5+k3s2
k3s-003                         Ready    control-plane,master   90m   v1.21.5+k3s2
k3s-004                         Ready    control-plane,master   80m   v1.21.5+k3s2
k3s-005                         Ready    control-plane,master   70m   v1.21.5+k3s2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;why-you-shouldnt-do-this&quot;&gt;Why you shouldn’t do this&lt;/h2&gt;
&lt;p&gt;Over 1.5 cores of the Pi is used by &lt;em&gt;k3s&lt;/em&gt;, never mind the workloads we want to run!&lt;/p&gt;

&lt;p&gt;Here’s a simple &lt;a href=&quot;https://github.com/reactive-tech/kubegres&quot;&gt;pod&lt;/a&gt; which didn’t manage to start, even after 5 mins due to the CPU limitations.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pi@node-001:~ &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;kubectl get pod &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt;
NAME                                              READY   STATUS              RESTARTS   AGE
kubegres-controller-manager-75b6765589-kvr97      1/2     ContainerCreating   0          4m54s
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;Don’t run x86 on Pis, especially not on kubernetes! They just aren’t fast enough (yet)&lt;/p&gt;</content><author><name></name></author><category term="Kubernetes" /><category term="QEMU" /><summary type="html">Running a Kubernetes native x86_64 application on Raspberry Pis, and why you shouldn’t!</summary></entry><entry><title type="html">How Slack and Discord prevent you scanning Infrastructure with link previews</title><link href="https://tales.fromprod.com/2021/223/how-slack-and-discord-stop-scanning-previews.html" rel="alternate" type="text/html" title="How Slack and Discord prevent you scanning Infrastructure with link previews" /><published>2021-08-11T20:00:00+01:00</published><updated>2021-08-11T20:00:00+01:00</updated><id>https://tales.fromprod.com/2021/223/how-slack-and-discord-stop-scanning-previews</id><content type="html" xml:base="https://tales.fromprod.com/2021/223/how-slack-and-discord-stop-scanning-previews.html">&lt;h1 id=&quot;how-slack-and-discord-prevent-you-scanning-infrastructure-with-link-previews&quot;&gt;How Slack and Discord prevent you scanning Infrastructure with link previews&lt;/h1&gt;

&lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;
This is based on conjecture for Discord, and reading some Slack docs. This is not based on statements from them.&lt;/p&gt;

&lt;h2 id=&quot;why-should-i-care-about-these-nice-previews&quot;&gt;Why should I care about these nice previews?&lt;/h2&gt;
&lt;p&gt;They’re running an HTTP GET from some machine somewhere, and then presenting some returned data from any source in a webpage… Sounds ripe for stored XSS/SSRF/recon/general shenanigans, doesn’t it? &lt;a href=&quot;https://elbs.medium.com/1-000-ssrf-in-slack-7737935d3884&quot;&gt;1&lt;/a&gt;,&lt;a href=&quot;https://hackerone.com/reports/381129&quot;&gt;2&lt;/a&gt;,&lt;a href=&quot;https://hackerone.com/reports/61312&quot;&gt;3&lt;/a&gt;,&lt;a href=&quot;https://gitlab.com/gitlab-org/gitlab/-/issues/28487&quot;&gt;4&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;how-they-prevent-you-scanning-the-network-around-the-receiver&quot;&gt;How they prevent you scanning the network around the receiver&lt;/h2&gt;

&lt;p&gt;They do the link loading server side, and then cache it for all clients [&lt;a href=&quot;https://api.slack.com/robots#link-expanding&quot;&gt;5&lt;/a&gt;]. This means the network calls come from the service servers, not the receiver which rules this out, phew!&lt;/p&gt;

&lt;p&gt;This is different to client side link loading (which is a &lt;em&gt;bad&lt;/em&gt; idea, see &lt;a href=&quot;https://www.perimeterx.com/tech-blog/2020/whatsapp-fs-read-vuln-disclosure/&quot;&gt;part 3&lt;/a&gt;)&lt;/p&gt;

&lt;h2 id=&quot;how-do-they-prevent-you-scanning-their-own-infra&quot;&gt;How do they prevent you scanning their own infra?&lt;/h2&gt;
&lt;p&gt;Say for example they are on AWS, you can get their servers to run any GET commands you want, even to the &lt;a href=&quot;https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html&quot;&gt;AWS metadata service&lt;/a&gt; which can be used for &lt;a href=&quot;https://www.shellntel.com/blog/2019/8/27/aws-metadata-endpoint-how-to-not-get-pwned-like-capital-one&quot;&gt;kill chains&lt;/a&gt;. That sounds fun right? (Not actually, please don’t do this without permission)&lt;/p&gt;

&lt;p&gt;So, why doesn’t this matter? They only return the information they found in specific tags &lt;a href=&quot;https://api.slack.com/robots#link-expanding&quot;&gt;5&lt;/a&gt; which rules out (probably) every interesting internal API, so you can run a GET but never get the information back.&lt;/p&gt;

&lt;p&gt;They may also be running a deny-list but these are never perfect.&lt;/p&gt;

&lt;h2 id=&quot;how-do-they-stop-you-injecting-random-code-into-the-page&quot;&gt;How do they stop you injecting random code into the page&lt;/h2&gt;
&lt;p&gt;Same protections as when you send a message, &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP&quot;&gt;Content Security Policies&lt;/a&gt; and setting context using &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML#security_considerations&quot;&gt;innerHTML&lt;/a&gt; (in the case of Discord.)&lt;/p&gt;

&lt;h2 id=&quot;tldr&quot;&gt;TLDR&lt;/h2&gt;
&lt;p&gt;They don’t run the preview HTTP requests from your machine, and only provide a well documented but uncommon (for infrastructure) set of tags.&lt;/p&gt;</content><author><name></name></author><category term="Slack" /><category term="APIs" /><category term="Discord" /><category term="Security" /><summary type="html">How Slack and Discord prevent you scanning Infrastructure with link previews</summary></entry><entry><title type="html">Managing Google Groups via the API, aka what they don’t want you to do!</title><link href="https://tales.fromprod.com/2021/223/managing-google-groups-via-api.html" rel="alternate" type="text/html" title="Managing Google Groups via the API, aka what they don’t want you to do!" /><published>2021-08-11T03:00:00+01:00</published><updated>2021-08-11T03:00:00+01:00</updated><id>https://tales.fromprod.com/2021/223/managing-google-groups-via-api</id><content type="html" xml:base="https://tales.fromprod.com/2021/223/managing-google-groups-via-api.html">&lt;h1 id=&quot;managing-google-groups-via-the-api-despite-their-best-efforts&quot;&gt;Managing Google Groups via the API, despite their best efforts&lt;/h1&gt;

&lt;p&gt;&lt;strong&gt; Better version available &lt;a href=&quot;/2022/011/improved-managing-google-groups.html&quot;&gt;here&lt;/a&gt; &lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Google have made it difficult to do this, they somewhat document two different APIs to achieve this, with limited success. This is especially true if you want to use a service account rather than a user API token for the management.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://developers.google.com/admin-sdk/directory/v1/guides/manage-groups&quot;&gt;Using the directory API&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://cloud.google.com/identity/docs/how-to/create-dynamic-groups&quot;&gt;Using the Cloud Identity APIs - newer and seems to be preferred going forward&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;At the time of writing, these are not sufficiently detailed to do more than work out those are the APIs to use. That’s where this guide comes in.&lt;/p&gt;

&lt;h2 id=&quot;what-this-will-help-you-achieve&quot;&gt;What this will help you achieve&lt;/h2&gt;

&lt;p&gt;A golang binary which manages the membership of a Google Group for you. The steps will likely apply to the other language client libraries&lt;/p&gt;

&lt;h2 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;Google Cloud Identity Premium&lt;/li&gt;
  &lt;li&gt;A paid for Google Workspace&lt;/li&gt;
  &lt;li&gt;A Google cloud Service Account (SA)
    &lt;ul&gt;
      &lt;li&gt;An API key for that SA&lt;/li&gt;
      &lt;li&gt;The email address of that SA&lt;/li&gt;
      &lt;li&gt;This SA requires &lt;strong&gt;no permissions at all&lt;/strong&gt; in the cloud console&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;The magic “Customer ID”
    &lt;ul&gt;
      &lt;li&gt;TThis can only be obtained by a workspace admin , via the steps on &lt;a href=&quot;https://support.google.com/a/answer/10070793?hl=en&quot;&gt;https://support.google.com/a/answer/10070793?hl=en&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;The google group you wish to manage
    &lt;ul&gt;
      &lt;li&gt;You should add the SA’s email address as an “OWNER” of that group, and change the subscription to “no emails” as it can’t receive them.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;dependencies&quot;&gt;Dependencies&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;A source of email addresses to add to your group&lt;/li&gt;
  &lt;li&gt;The &lt;a href=&quot;https://pkg.go.dev/google.golang.org/api@v0.51.0/cloudidentity/v1&quot;&gt;cloud identity client library&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;The &lt;a href=&quot;https://pkg.go.dev/google.golang.org/api@v0.52.0/option&quot;&gt;Google API options library&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The following is example code and won’t compile without changes, and lacks niceties like error handling and retrying in the face of inevitable errors.&lt;/p&gt;

&lt;p&gt;This should provide a clearer understanding of the hierarchy of the Google Groups data model.&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;//Whatever other deps you need go here&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;google.golang.org/api/cloudidentity/v1&quot;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;goption&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;google.golang.org/api/option&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// Variables to replace in this sample (nonworking) code&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// CXXXXXXXX -&amp;gt; Your customer ID&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// requiredGroup@example.com -&amp;gt; The email address of the google group you care about&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// &quot;a@a.com&quot;, &quot;b@a.com&quot; -&amp;gt; The actual list of emails you want added&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// addDelta -&amp;gt; A function to say which emails need added to the group based on current emails&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// removeDelta -&amp;gt; A function to say which emails need removed from the group based on current emails&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Create your goptions from your credential file.&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// This is the Service Account Key you downloaded during&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// The prerequisites.&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;goptions&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;goption&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithCredentialsFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/some/file/location.json&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;cis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;goptions&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Next you&apos;ll want to get the group you&apos;re interested in&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// The only way I found was to get all accessible groups&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Then filter for the relevant email address&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;groupsService&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewGroupsService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;gsl&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;groupsService&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Replace CXXXXXXXX with the customer ID&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// you got during prerequisites&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;gsl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;customers/CXXXXXXXX&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;listedGroupsResponse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;listedGroups&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;listedGroupsResponse&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Groups&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// The email address of the Group is actually the &quot;GroupKey.Id&quot;&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// logging out the first email address as we&apos;ll pretend that&apos;s what we want&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Rather than taking the first element, you would loop through and select&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// the one you want&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;relevantGroup&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Group&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;group&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;listedGroups&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;group&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GroupKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;requiredGroup@example.com&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;relevantGroup&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;group&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Group not found&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Email address of group was %+v&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;group&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GroupKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Now to get the membership of the group, so we can see the emails of the current members&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewGroupsMembershipsService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Response containing list of memberships&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;lmr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;groupName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Pulling out just the memberships&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;currentMemberships&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lmr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Memberships&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;member&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentMemberships&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// The EntityKey == PreferredMemberKey == the user email&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;member&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PreferredMemberKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;desiredEmails&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;a@a.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;b@a.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;//The following functions aren&apos;t defined, you need to define this logic yourself&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Example if you wish to only add the new emails&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Rather than deal with 409 which you get&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// if the email is already a member&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;additionalEmails&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;addDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desiredEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Example if you wish to remove any members who shouldn&apos;t be there&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;emailsToRemove&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;removeDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desiredEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentEmails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Now to add the new members&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;additionalEmails&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EntityKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;roles&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MembershipRole&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MembershipRole&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;MEMBER&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Despite the docs saying it&apos;s Member by default, we must explicitly set it&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Or you will get ERROR: googleapi: Error 400: resource.roles must be specified, badRequest&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// when trying to create the membership&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cloudidentity&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PreferredMemberKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Roles&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;roles&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;c&quot;&gt;// This part youll want to make retriable&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Any 409&apos;s are &quot;fine&quot; as it means the member already exists&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Using the &quot;Name&quot; found earlier as it&apos;s annoying to create due to format&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Create&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;relevantGroup&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;errStr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sprint&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Contains&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;errStr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Error 409&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Now to remove the extra members&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// Have a horrible loop as there doesn&apos;t seem to be a nice way to get a membership ID...&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// MembershipLookupCall doesn&apos;t exist :(&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;emailsForRemoval&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;

		&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentMemberships&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PreferredMemberKey&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;email&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Membership&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
				&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
					&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Encountered error while deleting membership %+v&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
					&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
					&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
				&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="Google" /><category term="APIs" /><category term="Golang" /><category term="Go" /><summary type="html">Managing Google Groups via the API, despite their best efforts</summary></entry><entry><title type="html">Slack-mojis, and why documenting API limitations helps!</title><link href="https://tales.fromprod.com/2021/217/always-document-api-limitations.html" rel="alternate" type="text/html" title="Slack-mojis, and why documenting API limitations helps!" /><published>2021-08-05T21:00:00+01:00</published><updated>2021-08-05T21:00:00+01:00</updated><id>https://tales.fromprod.com/2021/217/always-document-api-limitations</id><content type="html" xml:base="https://tales.fromprod.com/2021/217/always-document-api-limitations.html">&lt;h1 id=&quot;slackmojis-and-api-limits&quot;&gt;Slackmojis and API limits&lt;/h1&gt;
&lt;p&gt;During a “discussion” on our slack channel about long… thonks, a question occurred - “Just how many slackmojis can be sent in a slack message?”&lt;/p&gt;

&lt;h2 id=&quot;to-the-docs&quot;&gt;To the docs!&lt;/h2&gt;
&lt;p&gt;Slack &lt;a href=&quot;https://api.slack.com/changelog/2018-04-truncating-really-long-messages&quot;&gt;document&lt;/a&gt; that the max message length is &lt;em&gt;40,000 characters&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Given this, and that you can declare a slackmoji with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;:slackmoji:&lt;/code&gt; we should be able to send 40,000/(len(:slackmoji:)) right…?&lt;/p&gt;

&lt;p&gt;Okay, let’s generate that message, and then paste it in the text box&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;print(&quot;:longthonk1:&quot; + &quot;:longthonk2::longthonk3::longthonk4:&quot; * ((40000- len(&quot;:longthonk1:&quot;) - len(&quot;:longthonk5:&quot;) )// len(&quot;:longthonk2::longthonk3::longthonk4:&quot;)) + &quot;:longthonk5:&quot;)&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, turns out &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;xargs -J&lt;/code&gt; can’t interpolate 40k characters, and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;xargs -I&lt;/code&gt; can only do even fewer. The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-J&lt;/code&gt; doesn’t throw an error, it’ll only put the characters afterwards as if that flag is ignored. Who knew?&lt;/p&gt;

&lt;h3 id=&quot;what-happened&quot;&gt;What happened&lt;/h3&gt;
&lt;p&gt;So, you can paste this in and wait a &lt;em&gt;long&lt;/em&gt; time, as the slack client seems to parse the message for each slackmoji and then render it leading to the following great gif in real time&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/static/2021-08-05-always-document-api-limitations/slow-decoding.gif&quot; alt=&quot;Slack slowly parsing the message and rendering one slackmoji at a time&quot; width=&quot;610&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once it renders the message, nothing happens if you click the send button.&lt;/p&gt;

&lt;h3 id=&quot;now-what&quot;&gt;Now what?&lt;/h3&gt;
&lt;p&gt;Well, let’s assume that the web client wasn’t up to the challenge of our message (sorry devs). Why don’t we try the API ourselves?&lt;/p&gt;

&lt;h2 id=&quot;having-fun-at-the-expense-of-the-slack-api&quot;&gt;Having fun at the expense of the slack API&lt;/h2&gt;
&lt;p&gt;I didn’t want to create an app for this, so what do to? Using user API tokens for the API is no longer supported…. Or is it?&lt;/p&gt;

&lt;h3 id=&quot;getting-api-calls-to-work-with-user-tokens&quot;&gt;Getting API calls to work with user tokens&lt;/h3&gt;
&lt;p&gt;I got the network calls while sending a message and started stripping parts from it until I found the minimum that works…&lt;/p&gt;

&lt;p&gt;Turns out all you need is the user token, and the cookies (Ie everything in the value of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Cookie:&lt;/code&gt; request header). If you don’t include the cookie you’ll get an unauthorised response.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{&quot;ok&quot;: false, &quot;error&quot;: &quot;invalid_auth&quot;}&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;how-are-slackmojis-represented&quot;&gt;How are slackmojis represented?&lt;/h3&gt;

&lt;p&gt;After further experimentation, it turns out the API actually considers slackmojis to be emojis, and they have to be in a list of blocks. This makes it a bit harder to work out the max message size (and meet it)&lt;/p&gt;

&lt;h2 id=&quot;findings&quot;&gt;Findings&lt;/h2&gt;

&lt;h3 id=&quot;request-failed-successfully-or-unexpected-errors&quot;&gt;Request failed successfully or “Unexpected Errors”&lt;/h3&gt;
&lt;p&gt;If you try to send too many slackmojis in a message, you’ll get a 200 and a response of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;{&quot;ok&quot;:false,&quot;error&quot;:&quot;msg_blocks_too_long&quot;}&lt;/code&gt; which is frustrating. At least give me a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;400&lt;/code&gt; error!&lt;/p&gt;

&lt;p&gt;This error has the wonderful explanation in the &lt;a href=&quot;https://api.slack.com/methods/chat.postMessage#errors&quot;&gt;docs&lt;/a&gt;.
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;msg_blocks_too_long [hidden]	msg blocks too long (generated)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Slack support were lovely, but essentially wondering why would I do such a thing, and suggested I just don’t send as many emojis 😔&lt;/p&gt;

&lt;h3 id=&quot;max-length--max-length&quot;&gt;Max length != max length&lt;/h3&gt;
&lt;p&gt;The number of slackmojis you can send seems to vary, though on what I’m not sure. The message needs to be less than 40k characters long, but it also seems to depend on which slackmoji you want to send. It seems that you can only send about half as many animated slackmojis… Which seems to be for the best. The client gets &lt;em&gt;slow&lt;/em&gt; when you send 5 messages, each with &lt;em&gt;only&lt;/em&gt; 1,100 animated slackmojis.&lt;/p&gt;

&lt;h2 id=&quot;tldr&quot;&gt;TLDR&lt;/h2&gt;
&lt;p&gt;You should put sensible limits and validation on your API requests (+1 Slack) and document them (-1 Slack)&lt;/p&gt;

&lt;p&gt;Why? Someone will try to push them at some point, and it’s not always someone wanting to have a bit of innocent fun in a slack thread…&lt;/p&gt;

&lt;p&gt;Here’s a gif of the laggy aftermath&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/static/2021-08-05-always-document-api-limitations/laggy-rendering.gif&quot; alt=&quot;Slack rendering over 2,000 animated slackmojis judderingly&quot; width=&quot;720&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;sample-code&quot;&gt;Sample code&lt;/h2&gt;
&lt;p&gt;Please only use this for innocent fun, where you have permission as it can really slow a slack client if it has to render too many slackmojis.&lt;/p&gt;

&lt;p&gt;This snippet is provided under an &lt;a href=&quot;https://github.com/git/git-scm.com/blob/main/MIT-LICENSE.txt&quot;&gt;MIT license&lt;/a&gt; and I hold no responsibility for how you choose to use it.&lt;/p&gt;

&lt;div class=&quot;language-python highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;http.client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;urllib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;parse&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Replace
# TOKEN with your bearer token like xoxc-
# COOKIE with your browser cookies, you can get this from the network tab
# CHANNEL with the channel, something like DD95R8TDY, it&apos;ll be the second level in your browser ie $2 in https://app.slack.com/client/$1/$2
&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# If you want to reply to a thread replace
# THREAD with the thread_ts from inspecting the URL of the thread it&apos;ll be the fourth level in your browser ie $3 in  https://app.slack.com/client/$1/$2/thread/$2-$3
# otherwise remove &quot;thread_ts&quot;: &quot;THREAD&quot;,
&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HTTPSConnection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;slack.com&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Content-type&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;application/json; charset=utf-8&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Authorization&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Bearer TOKEN&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;cookie&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;COOKIE&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;extrathonk&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;,{&quot;type&quot;:&quot;emoji&quot;,&quot;name&quot;:&quot;thonking-intensifies&quot;},&apos;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;40600&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;{&quot;type&quot;:&quot;emoji&quot;,&quot;name&quot;:&quot;thonking-intensifies&quot;}&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;,{&quot;type&quot;:&quot;emoji&quot;,&quot;name&quot;:&quot;thonking-intensifies&quot;}&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;,{&quot;type&quot;:&quot;emoji&quot;,&quot;name&quot;:&quot;thonking-intensifies&quot;},&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;,{&quot;type&quot;:&quot;emoji&quot;,&quot;name&quot;:&quot;thonking-intensifies&quot;}&apos;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&apos;{&quot;channel&quot;: &quot;CHANNEL&quot;, &quot;thread_ts&quot;: &quot;THREAD&quot;,  &quot;blocks&quot;: [{&quot;type&quot;:&quot;rich_text&quot;,&quot;elements&quot;:[{&quot;type&quot;:&quot;rich_text_section&quot;,&quot;elements&quot;:[{&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;‎&quot;}, %s]}]}]}&apos;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;extrathonk&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;encode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;utf-8&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;POST&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/api/chat.postMessage&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;body&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;headers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;response&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getresponse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# response.reason Required as Slack will return a 200, even if your message fails due to &quot;msg_blocks_too_long&quot;.
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;reason&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="Slack" /><category term="APIs" /><category term="Nonsense" /><summary type="html">Slackmojis and API limits During a “discussion” on our slack channel about long… thonks, a question occurred - “Just how many slackmojis can be sent in a slack message?”</summary></entry><entry><title type="html">Welcome to Tales From Prod!</title><link href="https://tales.fromprod.com/2021/215/welcome-to-tales-from-prod.html" rel="alternate" type="text/html" title="Welcome to Tales From Prod!" /><published>2021-08-03T21:00:00+01:00</published><updated>2021-08-03T21:00:00+01:00</updated><id>https://tales.fromprod.com/2021/215/welcome-to-tales-from-prod</id><content type="html" xml:base="https://tales.fromprod.com/2021/215/welcome-to-tales-from-prod.html">&lt;p&gt;This blog is for rants about Kubernetes, Cloud Native applications, DevSecOps and whatever ends up being a “Tale from Prod”&lt;/p&gt;</content><author><name></name></author><summary type="html">This blog is for rants about Kubernetes, Cloud Native applications, DevSecOps and whatever ends up being a “Tale from Prod”</summary></entry></feed>